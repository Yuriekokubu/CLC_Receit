<!DOCTYPE html>
<html lang="th" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLC Finance - Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Sarabun:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Poppins', 'Sarabun', 'sans-serif'] } } }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', 'Sarabun', sans-serif;
        }

        /* Modern Loading Animation */
        .loader-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .loader-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: loader-rotate 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        .loader-ring:nth-child(2) {
            border-top-color: #a855f7;
            animation-delay: -0.3s;
        }

        .loader-ring:nth-child(3) {
            border-top-color: #ec4899;
            animation-delay: -0.6s;
        }

        @keyframes loader-rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .sidebar-active {
            background-color: #f1f5f9;
            border-right: 4px solid #4f46e5;
        }

        .dark .sidebar-active {
            background-color: #1e293b;
            border-right-color: #818cf8;
        }

        .status-pending {
            border-left: 5px solid #f59e0b;
        }

        .status-approved {
            border-left: 5px solid #10b981;
        }

        .status-rejected {
            border-left: 5px solid #ef4444;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-white p-10 rounded-2xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center mb-6">ADMIN LOGIN</h2>
            <div class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email"
                    class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-600">
                <input type="password" id="loginPassword" placeholder="Password"
                    class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-600">
                <button onclick="handleLogin()"
                    class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-black transition shadow-lg uppercase">Sign
                    In</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay"
        class="fixed inset-0 bg-white/95 dark:bg-slate-950/95 z-[60] flex items-center justify-center backdrop-blur-md">
        <div class="flex flex-col items-center">
            <div class="loader-container mb-4">
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
            </div>
            <p class="font-bold text-indigo-600 animate-pulse text-sm tracking-widest uppercase">Initializing App...</p>
        </div>
    </div>

    <div id="mainContent" class="hidden flex flex-col h-full">
        <header
            class="bg-white dark:bg-slate-900 border-b dark:border-slate-800 px-6 py-4 flex justify-between items-center z-50 shadow-sm">
            <div class="flex items-center gap-4">
                <button id="backBtn" onclick="toggleMobileList()"
                    class="md:hidden p-2 bg-slate-100 dark:bg-slate-800 rounded-lg hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 class="font-bold text-lg md:text-xl tracking-tight uppercase">CLC ‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</h1>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="switchView('dashboard')" id="dashToggle"
                    class="text-[10px] md:text-xs font-bold px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg">DASHBOARD</button>
                <button onclick="switchView('list')" id="listToggle"
                    class="text-[10px] md:text-xs font-bold px-3 py-2 bg-indigo-600 text-white rounded-lg">LIST</button>
                <button onclick="switchView('calendar')" id="calToggle"
                    class="text-[10px] md:text-xs font-bold px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg">CALENDAR</button>
                <button onclick="toggleDarkMode()" class="p-2">üåô</button>
                <button onclick="handleLogout()" class="text-[10px] md:text-xs font-bold text-red-500">LOGOUT</button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden" id="appBody">
            <aside
                class="mobile-sidebar w-full md:w-[380px] bg-white dark:bg-slate-900 border-r dark:border-slate-800 flex flex-col">
                <div id="listView" class="flex flex-col h-full">
                    <div class="p-4 border-b dark:border-slate-800">
                        <input type="text" id="searchInput" oninput="handleSearch()"
                            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..."
                            class="w-full p-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl outline-none focus:ring-2 focus:ring-indigo-600 text-sm font-medium">
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll" id="receiptsList"></div>
                </div>

                <div id="calendarView"
                    class="hidden flex flex-col h-full p-3 overflow-y-auto bg-white dark:bg-slate-900">
                    <div id='calendar' class="text-xs"></div>
                </div>
            </aside>

            <main class="mobile-detail flex-1 bg-slate-50 dark:bg-slate-950 overflow-y-auto custom-scroll p-4 md:p-8">
                <div id="dashboardPage" class="hidden max-w-5xl mx-auto space-y-6">
                    <h2 class="text-2xl font-bold">Financial Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800 shadow-sm">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 text-center">
                                ‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</p>
                            <div class="h-64"><canvas id="categoryChart"></canvas></div>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800 shadow-sm flex flex-col justify-center items-center">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </p>
                            <p id="totalSpentDisplay" class="text-5xl font-black text-indigo-600">0.00 ‡∏ø</p>
                        </div>
                    </div>
                </div>

                <div id="detailContainer" class="max-w-5xl mx-auto h-full">
                    <div
                        class="h-full flex flex-col items-center justify-center text-slate-400 border-2 border-dashed rounded-3xl border-slate-200 dark:border-slate-800 opacity-40">
                        <p class="text-sm font-bold tracking-widest">SELECT A RECORD TO VIEW DETAILS</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="imageModal"
        class="fixed inset-0 bg-slate-950/90 z-[200] hidden flex items-center justify-center p-8 backdrop-blur-md"
        onclick="closeImage()">
        <img id="modalImg" class="max-w-full max-h-full rounded-xl shadow-2xl" src="">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCkiq5_IM-1-REojhiAOjDgF-aQI9LMhHk", authDomain: "clc-e-receit.firebaseapp.com", projectId: "clc-e-receit", storageBucket: "clc-e-receit.firebasestorage.app", messagingSenderId: "578514019900", appId: "1:578514019900:web:998f3e9fa3b599a2344539" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let allData = [];
        let selectedId = null;
        let calendar = null;
        let spendingChart = null;
        let isFirstLoad = true;

        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }

        function switchView(view) {
            const listEl = document.getElementById('listView');
            const calEl = document.getElementById('calendarView');
            const dashEl = document.getElementById('dashboardPage');
            const detailEl = document.getElementById('detailContainer');

            [listEl, calEl, dashEl, detailEl].forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('header button[id*="Toggle"]').forEach(btn => {
                btn.className = "text-[10px] md:text-xs font-bold px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg";
            });

            if (view === 'dashboard') {
                dashEl.classList.remove('hidden');
                document.getElementById('dashToggle').className = "text-[10px] md:text-xs font-bold px-3 py-2 bg-indigo-600 text-white rounded-lg";
                updateChart();
            } else if (view === 'calendar') {
                calEl.classList.remove('hidden');
                detailEl.classList.remove('hidden');
                document.getElementById('calToggle').className = "text-[10px] md:text-xs font-bold px-3 py-2 bg-indigo-600 text-white rounded-lg";
                if (calendar) calendar.render();
            } else {
                listEl.classList.remove('hidden');
                detailEl.classList.remove('hidden');
                document.getElementById('listToggle').className = "text-[10px] md:text-xs font-bold px-3 py-2 bg-indigo-600 text-white rounded-lg";
            }
        }

        auth.onAuthStateChanged(user => {
            document.getElementById('loginOverlay').classList.toggle('hidden', !!user);
            document.getElementById('mainContent').classList.toggle('hidden', !user);
            if (user) { setupListener(); initCalendar(); }
        });

        async function handleLogin() {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPassword').value;
            try { await auth.signInWithEmailAndPassword(e, p); } catch (err) { alert("Login Failed"); }
        }
        function handleLogout() { auth.signOut(); }

        function setupListener() {
            db.collection('expenseReceipts').orderBy('createdAt', 'desc').onSnapshot(snap => {
                allData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                handleSearch();
                updateCalendarEvents();
                if (isFirstLoad) {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    isFirstLoad = false;
                }
                if (selectedId) {
                    const item = allData.find(r => r.id === selectedId);
                    if (item) renderDetail(item);
                }
            });
        }

        function handleSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(i =>
                (i.personInCharge?.toLowerCase().includes(term)) ||
                (i.category?.toLowerCase().includes(term)) ||
                (i.date?.includes(term))
            );
            renderList(filtered);
        }

        function renderList(items) {
            const container = document.getElementById('receiptsList');

            const approved = items.filter(r => r.isApproved === true);
            const rejected = items.filter(r => r.status === 'rejected');
            const pending = items.filter(r => r.isApproved !== true && r.status !== 'rejected');

            const createSection = (title, list, textColor) => {
                if (list.length === 0) return '';
                return `
                    <div class="p-2 bg-slate-100 dark:bg-slate-800 text-[10px] font-black uppercase tracking-widest text-slate-500">${title} (${list.length})</div>
                    ${list.map(r => {
                    const sClass = r.isApproved ? 'status-approved' : (r.status === 'rejected' ? 'status-rejected' : 'status-pending');
                    return `
                            <div onclick="selectItem('${r.id}')" class="p-4 border-b dark:border-slate-800 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 ${selectedId === r.id ? 'sidebar-active' : ''} ${sClass}">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-sm truncate w-2/3">${r.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</span>
                                    <span class="font-black text-indigo-600 text-sm">${formatMoney(r.grandTotal)}</span>
                                </div>
                                <div class="flex justify-between text-[10px] font-bold uppercase text-slate-500">
                                    <span>${r.personInCharge} | ${r.date}</span>
                                    <span class="${textColor}">${title}</span>
                                </div>
                            </div>`;
                }).join('')}`;
            };

            container.innerHTML =
                createSection('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', pending, 'text-amber-500') +
                createSection('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', approved, 'text-emerald-500') +
                createSection('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', rejected, 'text-red-500');
        }

        function updateChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const summary = {};
            let total = 0;
            allData.forEach(r => {
                const cat = r.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                summary[cat] = (summary[cat] || 0) + (r.grandTotal || 0);
                total += (r.grandTotal || 0);
            });
            document.getElementById('totalSpentDisplay').innerText = total.toLocaleString('th-TH', { minimumFractionDigits: 2 }) + " ‡∏ø";

            if (spendingChart) spendingChart.destroy();
            spendingChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(summary),
                    datasets: [{
                        data: Object.values(summary),
                        backgroundColor: ['#6366f1', '#a855f7', '#ec4899', '#f59e0b', '#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
            });
        }

        function initCalendar() {
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', locale: 'th', height: 'auto',
                dateClick: (info) => { document.getElementById('searchInput').value = info.dateStr; handleSearch(); switchView('list'); },
                eventContent: (arg) => {
                    let h = `<div class="flex gap-1">`;
                    if (arg.event.extendedProps.p > 0) h += `<span class="px-1 bg-amber-500 text-white text-[9px] rounded">${arg.event.extendedProps.p}</span>`;
                    if (arg.event.extendedProps.a > 0) h += `<span class="px-1 bg-emerald-500 text-white text-[9px] rounded">${arg.event.extendedProps.a}</span>`;
                    if (arg.event.extendedProps.r > 0) h += `<span class="px-1 bg-red-500 text-white text-[9px] rounded">${arg.event.extendedProps.r}</span>`;
                    return { html: h + `</div>` };
                }
            });
        }

        function updateCalendarEvents() {
            const groups = {};
            allData.forEach(r => {
                if (!groups[r.date]) groups[r.date] = { p: 0, a: 0, r: 0 };
                if (r.isApproved) groups[r.date].a++; else if (r.status === 'rejected') groups[r.date].r++; else groups[r.date].p++;
            });
            calendar.removeAllEvents();
            calendar.addEventSource(Object.keys(groups).map(d => ({ start: d, allDay: true, extendedProps: groups[d], backgroundColor: 'transparent', borderColor: 'transparent' })));
        }

        function selectItem(id) {
            selectedId = id;
            handleSearch(); // Update selected style in list
            const item = allData.find(r => r.id === id);
            if (item) renderDetail(item);
            if (window.innerWidth < 768) {
                document.getElementById('appBody').classList.add('mobile-view-detail');
                document.getElementById('backBtn').classList.remove('hidden');
            }
        }

        function toggleMobileList() {
            document.getElementById('appBody').classList.remove('mobile-view-detail');
            document.getElementById('backBtn').classList.add('hidden');
        }

        function renderDetail(data) {
            const isApp = data.isApproved;
            const isRej = data.status === 'rejected';
            document.getElementById('detailContainer').innerHTML = `
                <div class="space-y-6 pb-20">
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between gap-4">
                            <div>
                                <h2 class="text-3xl font-extrabold tracking-tighter">${data.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</h2>
                                <p class="text-slate-500 text-sm font-bold">‡πÇ‡∏î‡∏¢: ${data.personInCharge} | ${data.date}</p>
                            </div>
                            <div class="md:text-right">
                                <p class="text-4xl font-black text-indigo-600">${formatMoney(data.grandTotal)} ‡∏ø</p>
                                <div class="flex gap-2 mt-3 md:justify-end">
                                    ${(!isApp && !isRej) ? `
                                        <button onclick="updateStatus('${data.id}','approve')" class="px-4 py-2 bg-emerald-600 text-white text-xs font-bold rounded-xl shadow-lg hover:bg-emerald-700 transition">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                        <button onclick="updateStatus('${data.id}','reject')" class="px-4 py-2 bg-red-600 text-white text-xs font-bold rounded-xl shadow-lg hover:bg-red-700 transition">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                    ` : `<button onclick="resetStatus('${data.id}')" class="text-[10px] font-bold text-slate-400 border px-3 py-1 rounded-lg">‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Reset)</button>`}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-slate-900 rounded-3xl border dark:border-slate-800 overflow-x-auto">
                        <table class="w-full text-left min-w-[500px]">
                            <thead class="bg-slate-50 dark:bg-slate-800 text-[10px] font-black uppercase text-slate-400 border-b dark:border-slate-800">
                                <tr><th class="p-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="p-4 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="p-4 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-4 text-right">‡∏£‡∏ß‡∏°</th></tr>
                            </thead>
                            <tbody>
                                ${data.items.map(i => `<tr class="text-xs border-b dark:border-slate-800"><td class="p-4 font-bold">${i.name}</td><td class="p-4 text-right">${formatMoney(i.price || (i.total / i.qty))}</td><td class="p-4 text-center">${i.qty}</td><td class="p-4 text-right font-black text-indigo-600">${formatMoney(i.total)}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800"><p class="text-[10px] font-black text-slate-400 uppercase mb-4">Signature</p><img src="${data.signatureData}" class="max-h-24 mx-auto dark:invert"></div>
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800"><p class="text-[10px] font-black text-slate-400 uppercase mb-4">Attachments</p><div class="flex gap-2 overflow-x-auto">${data.receiptImages ? data.receiptImages.map(img => `<img src="${img}" onclick="openImage(this.src)" class="h-32 w-32 object-cover rounded-xl border cursor-zoom-in">`).join('') : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå'}</div></div>
                    </div>
                </div>`;
        }

        async function updateStatus(id, a) {
            const isApp = a === 'approve';
            await db.collection('expenseReceipts').doc(id).update({ isApproved: isApp, status: isApp ? 'approved' : 'rejected' });
            Toastify({ text: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", background: isApp ? "#10b981" : "#ef4444", gravity: "bottom" }).showToast();
        }

        async function resetStatus(id) {
            await db.collection('expenseReceipts').doc(id).update({ isApproved: false, status: 'pending' });
            Toastify({ text: "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß", background: "#6366f1", gravity: "bottom" }).showToast();
        }

        function openImage(s) { document.getElementById('modalImg').src = s; document.getElementById('imageModal').classList.remove('hidden'); }
        function closeImage() { document.getElementById('imageModal').classList.add('hidden'); }
        const formatMoney = (n) => parseFloat(n || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 });
    </script>
</body>

</html>