<!DOCTYPE html>
<html lang="th" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLC Finance - Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Sarabun:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Poppins', 'Sarabun', 'sans-serif'] } } }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', 'Sarabun', sans-serif;
        }

        /* Modern Loading Animation */
        .loader-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .loader-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: loader-rotate 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        .loader-ring:nth-child(2) {
            border-top-color: #a855f7;
            animation-delay: -0.3s;
        }

        .loader-ring:nth-child(3) {
            border-top-color: #ec4899;
            animation-delay: -0.6s;
        }

        @keyframes loader-rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .sidebar-active {
            background-color: #f1f5f9;
            border-right: 4px solid #4f46e5;
        }

        .dark .sidebar-active {
            background-color: #1e293b;
            border-right-color: #818cf8;
        }

        .status-pending {
            border-left: 5px solid #f59e0b;
        }

        .status-approved {
            border-left: 5px solid #10b981;
        }

        .status-rejected {
            border-left: 5px solid #ef4444;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[100] hidden flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-white p-10 rounded-2xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center mb-6 text-slate-900">ADMIN LOGIN</h2>
            <div class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email"
                    class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-600 text-slate-900">

                <div class="relative">
                    <input type="password" id="loginPassword" placeholder="Password"
                        class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-600 text-slate-900">
                    <button type="button" onclick="togglePasswordVisibility()"
                        class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-indigo-600 transition">
                        <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>

                <button onclick="handleLogin()"
                    class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-black transition shadow-lg uppercase">Sign
                    In</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay"
        class="fixed inset-0 bg-white/95 dark:bg-slate-950/95 z-[60] flex items-center justify-center backdrop-blur-md">
        <div class="flex flex-col items-center">
            <div class="loader-container mb-4">
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
            </div>
            <p class="font-bold text-indigo-600 animate-pulse text-sm tracking-widest uppercase">Initializing App...</p>
        </div>
    </div>

    <div id="mainContent" class="hidden flex flex-col h-full">
        <header
            class="bg-white dark:bg-slate-900 border-b dark:border-slate-800 px-4 md:px-6 py-4 flex justify-between items-center z-[60] shadow-sm sticky top-0">
            <div class="flex items-center gap-3">
                <button id="backBtn" onclick="toggleMobileList()"
                    class="md:hidden p-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-600">
                    <svg id="menuIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <h1
                    class="font-bold text-base md:text-xl tracking-tight uppercase truncate max-w-[120px] md:max-w-none">
                    CLC ADMIN</h1>
            </div>
            <div class="flex items-center gap-1.5 md:gap-2">
                <div class="relative">
                    <button onclick="toggleNotifyDropdown()"
                        class="p-2 md:p-2.5 bg-slate-100 dark:bg-slate-800 rounded-xl transition-all hover:scale-105 text-slate-600 dark:text-slate-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span id="notifyBadge"
                            class="hidden absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white ring-2 ring-white dark:ring-slate-900">0</span>
                    </button>

                    <div id="notifyDropdown"
                        class="hidden absolute right-0 mt-3 w-80 bg-white dark:bg-slate-900 border dark:border-slate-800 shadow-2xl rounded-2xl z-[100] overflow-hidden">
                        <div
                            class="p-4 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                            <span class="text-xs font-black uppercase tracking-widest">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</span>
                            <button onclick="clearNotify()"
                                class="text-[10px] text-indigo-500 font-bold hover:underline">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        </div>
                        <div id="notifyList"
                            class="max-h-80 overflow-y-auto custom-scroll divide-y dark:divide-slate-800">
                            <p class="p-6 text-center text-xs text-slate-400 font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
                        </div>
                    </div>
                </div>

                <button onclick="switchView('dashboard')" id="dashToggle"
                    class="p-2 md:p-2.5 bg-slate-100 dark:bg-slate-800 rounded-xl transition-all hover:scale-105"
                    title="Dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H18a2.25 2.25 0 0 1-2.25-2.25v-2.25Z" />
                    </svg>
                </button>


                <button onclick="switchView('list')" id="listToggle"
                    class="p-2 md:p-2.5 bg-indigo-600 text-white rounded-xl transition-all hover:scale-105"
                    title="List View">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                    </svg>
                </button>

                <button onclick="switchView('calendar')" id="calToggle"
                    class="p-2 md:p-2.5 bg-slate-100 dark:bg-slate-800 rounded-xl transition-all hover:scale-105"
                    title="Calendar View">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
                    </svg>
                </button>

                <div class="w-px h-6 bg-slate-200 dark:bg-slate-800 mx-1"></div>

                <button id="themeIcon" onclick="toggleDarkMode()"
                    class="p-2 text-xl hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">üåô</button>

                <button onclick="handleLogout()"
                    class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden relative" id="appBody">
            <aside id="sidebarArea"
                class="absolute inset-y-0 left-0 z-20 w-full md:relative md:translate-x-0 md:w-[380px] bg-white dark:bg-slate-900 border-r dark:border-slate-800 flex flex-col transition-transform duration-300">
                <div id="listView" class="flex flex-col h-full">
                    <div class="p-4 border-b dark:border-slate-800">
                        <input type="text" id="searchInput" oninput="handleSearch()"
                            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà, ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå..."
                            class="w-full p-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl outline-none focus:ring-2 focus:ring-indigo-600 text-sm font-medium">
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll" id="receiptsList"></div>
                </div>

                <div id="calendarView" class="hidden flex flex-col h-full p-3 overflow-y-auto">
                    <div id='calendar' class="text-xs"></div>
                </div>

                <div id="dashboardSidebar" class="hidden flex flex-col h-full bg-slate-50 dark:bg-slate-900/50">
                    <div class="p-6 border-b dark:border-slate-800 bg-white dark:bg-slate-900">
                        <h3 class="font-black text-lg tracking-tight">DASHBOARD CONTROL</h3>
                        <p class="text-xs text-slate-500 font-bold uppercase tracking-tighter">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </p>
                    </div>
                    <div class="p-4 space-y-6 overflow-y-auto">
                        <div>
                            <label
                                class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô</label>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="filterByStatus('pending')"
                                    class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-2xl hover:bg-amber-50 dark:hover:bg-amber-900/20 transition-all border dark:border-slate-700 shadow-sm group">
                                    <span
                                        class="text-sm font-bold text-slate-600 dark:text-slate-300">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                    <span class="bg-amber-500 text-white px-2.5 py-1 rounded-lg text-xs font-black"
                                        id="sideStatPending">0</span>
                                </button>
                                <button onclick="filterByStatus('all')"
                                    class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-2xl hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-all border dark:border-slate-700 shadow-sm">
                                    <span class="text-sm font-bold text-slate-600 dark:text-slate-300">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                    <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="pt-6 border-t dark:border-slate-800">
                            <label
                                class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                            <button onclick="exportToCSV()"
                                class="w-full flex items-center justify-center gap-2 p-4 bg-slate-900 dark:bg-indigo-600 hover:scale-[1.02] text-white rounded-2xl font-bold text-sm transition-all shadow-xl">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                EXPORT TO EXCEL (CSV)
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="flex-1 bg-slate-50 dark:bg-slate-950 overflow-y-auto custom-scroll p-4 md:p-8 w-full">
                <div id="dashboardPage" class="hidden max-w-5xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black tracking-tighter">FINANCIAL OVERVIEW</h2>
                            <p class="text-slate-500 font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                        </div>
                        <div
                            class="bg-indigo-600 text-white p-4 rounded-3xl shadow-lg shadow-indigo-500/30 text-right min-w-[200px]">
                            <span class="text-[10px] font-black uppercase opacity-80 tracking-widest">Total Spent</span>
                            <p id="totalSpentDisplay" class="text-3xl font-black leading-none">0.00 ‡∏ø</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div onclick="filterByStatus('all')"
                            class="bg-white dark:bg-slate-900 p-5 rounded-3xl border dark:border-slate-800 shadow-sm cursor-pointer hover:ring-2 hover:ring-indigo-500 transition-all">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p id="statTotal" class="text-3xl font-black">0</p>
                        </div>
                        <div onclick="filterByStatus('pending')"
                            class="bg-white dark:bg-slate-900 p-5 rounded-3xl border dark:border-slate-800 shadow-sm border-l-4 border-l-amber-500 cursor-pointer hover:bg-amber-50 dark:hover:bg-amber-900/10 transition-all">
                            <p class="text-[10px] font-black text-amber-600 uppercase mb-1">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                            <p id="statPending" class="text-3xl font-black text-amber-600">0</p>
                        </div>
                        <div onclick="filterByStatus('approved')"
                            class="bg-white dark:bg-slate-900 p-5 rounded-3xl border dark:border-slate-800 shadow-sm border-l-4 border-l-emerald-500 cursor-pointer hover:bg-emerald-50 dark:hover:bg-emerald-900/10 transition-all">
                            <p class="text-[10px] font-black text-emerald-600 uppercase mb-1">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
                            <p id="statApproved" class="text-3xl font-black text-emerald-600">0</p>
                        </div>
                        <div onclick="filterByStatus('rejected')"
                            class="bg-white dark:bg-slate-900 p-5 rounded-3xl border dark:border-slate-800 shadow-sm border-l-4 border-l-red-500 cursor-pointer hover:bg-red-50 dark:hover:bg-red-900/10 transition-all">
                            <p class="text-[10px] font-black text-red-600 uppercase mb-1">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                            <p id="statRejected" class="text-3xl font-black text-red-600">0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div
                            class="md:col-span-1 bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">
                                ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á)</p>
                            <div class="h-64"><canvas id="categoryChart"></canvas></div>
                            <div id="categoryListContainer"
                                class="mt-4 space-y-1 max-h-40 overflow-y-auto custom-scroll"></div>
                        </div>
                        <div
                            class="md:col-span-2 bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">
                                ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ 7 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                            <div class="h-64"><canvas id="trendChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="detailContainer" class="max-w-5xl mx-auto h-full">
                    <div
                        class="h-full flex flex-col items-center justify-center text-slate-400 border-2 border-dashed rounded-3xl border-slate-200 dark:border-slate-800 opacity-40">
                        <p class="text-xs font-bold tracking-widest text-center px-4">SELECT A RECORD TO VIEW DETAILS
                        </p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="imageModal"
        class="fixed inset-0 bg-slate-950/90 z-[200] hidden flex items-center justify-center p-8 backdrop-blur-md"
        onclick="closeImage()">
        <img id="modalImg" class="max-w-full max-h-full rounded-xl shadow-2xl" src="">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCkiq5_IM-1-REojhiAOjDgF-aQI9LMhHk",
            authDomain: "clc-e-receit.firebaseapp.com",
            projectId: "clc-e-receit",
            storageBucket: "clc-e-receit.firebasestorage.app",
            messagingSenderId: "578514019900",
            appId: "1:578514019900:web:998f3e9fa3b599a2344539"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let allData = [];
        let selectedId = null;
        let calendar = null;
        let spendingChart = null;

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Refresh ---
        auth.onAuthStateChanged(user => {
            const loginOverlay = document.getElementById('loginOverlay');
            const mainContent = document.getElementById('mainContent');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if (user) {
                // ‡∏ñ‡πâ‡∏≤ Login ‡πÅ‡∏•‡πâ‡∏ß: ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                loginOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');

                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                setupListener();
                initCalendar();
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login: ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                loginOverlay.classList.remove('hidden');
                mainContent.classList.add('hidden');

                // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Loading ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ
                loadingOverlay.classList.add('hidden');
            }
        });

        async function handleLogin() {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPassword').value;
            try {
                await auth.signInWithEmailAndPassword(e, p);
            } catch (err) {
                alert("Login Failed: " + err.message);
            }
        }

        function handleLogout() {
            auth.signOut();
        }


        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á script (‡∏ô‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
        const appStartTime = new Date();

        function setupListener() {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            db.collection('expenseReceipts').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const changes = snap.docChanges();

                // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Notification
                if (!isFirstLoad) {
                    changes.forEach(change => {
                        // ‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô 'added' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                        if (change.type === "added") {
                            const data = change.doc.data();
                            const docId = change.doc.id;

                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤:
                            // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå createdAt ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á "‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å" ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ/Login ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                            if (data.createdAt) {
                                const createdTime = data.createdAt.toDate();

                                if (createdTime > appStartTime) {
                                    const newDoc = { id: docId, ...data };
                                    addNotification(newDoc);
                                }
                            }
                        }
                    });
                }

                // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ allData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏Å‡∏£‡∏≤‡∏ü
                allData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // 3. ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£ Filter ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
                if (currentFilterData) {
                    const lastCategory = currentFilterData[0]?.category;
                    if (lastCategory) {
                        currentFilterData = allData.filter(r => r.category === lastCategory);
                    } else {
                        handleSearch();
                    }
                }

                // 4. ‡∏™‡∏±‡πà‡∏á Re-render UI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                handleSearch();
                updateStatusCards();
                updateCategoryList();
                updateCalendarEvents();

                // 5. ‡∏õ‡∏¥‡∏î Loading Overlay ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Flag ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }

                isFirstLoad = false;

                // 6. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Detail ‡∏î‡πâ‡∏ß‡∏¢
                if (selectedId) {
                    const item = allData.find(r => r.id === selectedId);
                    if (item) renderDetail(item);
                }
            });
        }

        document.getElementById('searchInput').oninput = () => {
            displayLimit = 15;
            handleSearch();
        };

        function handleSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();

            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô/‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ currentFilterData ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ allData
            let source = currentFilterData || allData;

            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î (Timestamp ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤) ‡πÑ‡∏õ ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î ---
            const sortedData = [...source].sort((a, b) => {
                // ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å createdAt (Firebase Timestamp) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ 0
                const timeA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate().getTime() : new Date(a.createdAt).getTime()) : 0;
                const timeB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate().getTime() : new Date(b.createdAt).getTime()) : 0;

                return timeB - timeA; // B ‡∏•‡∏ö A ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ (‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤) ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î
            });

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search) ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß
            const filtered = sortedData.filter(i =>
                (i.personInCharge && i.personInCharge.toLowerCase().includes(term)) ||
                (i.category && i.category.toLowerCase().includes(term)) ||
                (i.purpose && i.purpose.toLowerCase().includes(term)) ||
                (i.id && i.id.toLowerCase().includes(term))
            );

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà Sidebar
            renderList(filtered);
        }


        let displayLimit = 15; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á

        function renderList(items) {
            const container = document.getElementById('receiptsList');
            if (!container) return;

            const totalItems = items.length;
            const visibleItems = items.slice(0, displayLimit);

            const approved = visibleItems.filter(r => r.isApproved === true);
            const rejected = visibleItems.filter(r => r.status === 'rejected');
            const pending = visibleItems.filter(r => r.isApproved !== true && r.status !== 'rejected');

            const createSection = (title, list, type) => {
                if (list.length === 0) return '';
                let headerBg = type === 'p' ? 'bg-amber-500' : (type === 'a' ? 'bg-emerald-500' : 'bg-red-500');
                let badgeColor = type === 'p' ? 'text-amber-600' : (type === 'a' ? 'text-emerald-600' : 'text-red-600');

                return `
        <div class="sticky top-0 z-10 px-4 py-2 ${headerBg} shadow-md">
            <div class="flex items-center justify-between">
                <span class="text-white text-lg font-black tracking-wider">${title}</span>
                <span class="bg-white/90 px-3 py-0.5 rounded-full text-sm font-black ${badgeColor}">${list.length}</span>
            </div>
        </div>
        ${list.map(r => {
                    const sClass = r.isApproved ? 'status-approved' : (r.status === 'rejected' ? 'status-rejected' : 'status-pending');
                    const isActive = selectedId === r.id ? 'bg-indigo-50 dark:bg-indigo-900/40 ring-2 ring-indigo-500 z-[5]' : 'bg-white dark:bg-slate-900';

                    return `
            <div onclick="selectItem('${r.id}')" class="relative p-3 border-b dark:border-slate-800 cursor-pointer transition-all hover:bg-slate-50 dark:hover:bg-slate-800 ${isActive} ${sClass}">
                <div class="flex justify-between items-center">
                    <div class="flex-1 truncate pr-2">
                        <h3 class="text-lg font-extrabold text-slate-900 dark:text-white truncate leading-tight">${r.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400 font-bold truncate">
                            <span class="text-indigo-500">${r.date || '-'}</span> ‚Ä¢ ${r.purpose || '-'}
                        </p>
                    </div>
                    <div class="text-right">
                        <span class="text-lg font-black text-indigo-600 dark:text-indigo-400">${formatMoney(r.grandTotal)}</span>
                        <div class="text-[10px] font-bold text-slate-400 uppercase leading-none">${r.personInCharge}</div>
                    </div>
                </div>
            </div>`;
                }).join('')}`;
            };

            let html = createSection('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', pending, 'p') +
                createSection('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', approved, 'a') +
                createSection('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', rejected, 'r');

            if (totalItems > displayLimit) {
                html += `
        <div class="p-6 text-center">
            <button onclick="loadMore()" class="w-full py-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-2xl font-black text-xs tracking-widest uppercase hover:bg-indigo-600 hover:text-white transition-all shadow-sm">
                LOAD MORE (${totalItems - displayLimit} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
            </button>
        </div>`;
            }

            container.innerHTML = html;
        }

        function loadMore() {
            displayLimit += 15; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞ 15 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            handleSearch();     // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å handleSearch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏° Limit ‡πÉ‡∏´‡∏°‡πà
        }


        function initCalendar() {
            const calEl = document.getElementById('calendar');
            if (!calEl) return;

            calendar = new FullCalendar.Calendar(calEl, {
                initialView: 'dayGridMonth',
                locale: 'th',
                height: 'auto',
                headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },

                eventClick: function (info) {
                    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Event ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
                    const status = info.event.extendedProps.status;
                    const clickedDate = info.event.extendedProps.date;

                    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentFilterData
                    currentFilterData = allData.filter(r => {
                        const isSameDate = r.date === clickedDate;
                        if (!isSameDate) return false;

                        if (status === 'approved') return r.isApproved === true;
                        if (status === 'rejected') return r.status === 'rejected';
                        if (status === 'pending') return r.isApproved !== true && r.status !== 'rejected';
                        return false;
                    });

                    // 3. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ List
                    switchView('list');

                    // 4. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (Sidebar ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á)
                    displayLimit = 15; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Load More
                    handleSearch();    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ô‡∏≥ currentFilterData ‡πÑ‡∏õ‡∏ß‡∏≤‡∏î‡∏•‡∏á sidebar
                }
            });
            calendar.render();
        }

        function updateCalendarEvents() {
            if (!calendar) return;
            calendar.removeAllEvents();

            const summary = {};
            allData.forEach(r => {
                if (!summary[r.date]) summary[r.date] = { p: 0, a: 0, r: 0 };
                if (r.isApproved) summary[r.date].a++;
                else if (r.status === 'rejected') summary[r.date].r++;
                else summary[r.date].p++;
            });

            const events = [];
            Object.keys(summary).forEach(date => {
                const s = summary[date];
                // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà extendedProps ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô
                if (s.p > 0) events.push({
                    title: `üü° ‡∏£‡∏≠: ${s.p}`, start: date, backgroundColor: '#f59e0b', borderColor: 'transparent',
                    extendedProps: { status: 'pending', date: date }
                });
                if (s.a > 0) events.push({
                    title: `üü¢ ‡∏ú‡πà‡∏≤‡∏ô: ${s.a}`, start: date, backgroundColor: '#10b981', borderColor: 'transparent',
                    extendedProps: { status: 'approved', date: date }
                });
                if (s.r > 0) events.push({
                    title: `üî¥ ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ${s.r}`, start: date, backgroundColor: '#ef4444', borderColor: 'transparent',
                    extendedProps: { status: 'rejected', date: date }
                });
            });
            calendar.addEventSource(events);
        }

        function selectItem(id) {
            selectedId = id;
            handleSearch();
            const item = allData.find(r => r.id === id);
            if (item) renderDetail(item);

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô Sidebar ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            if (window.innerWidth < 768) {
                document.getElementById('sidebarArea').classList.add('-translate-x-full');
            }
        }

        function toggleMobileList() {
            const sidebar = document.getElementById('sidebarArea');
            const menuIcon = document.getElementById('menuIcon');

            const isHidden = sidebar.classList.toggle('-translate-x-full');

            // ‡∏ñ‡πâ‡∏≤ Sidebar ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏°‡πà Hidden) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô X
            if (!isHidden) {
                menuIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />`;
            } else {
                // ‡∏ñ‡πâ‡∏≤ Sidebar ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô 3 ‡∏Ç‡∏µ‡∏î
                menuIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />`;
            }
        }

        let trendChart = null;
        let currentFilterData = null; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å Dashboard

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ Sidebar
        function switchView(view) {
            const listEl = document.getElementById('listView');
            const calEl = document.getElementById('calendarView');
            const dashSideEl = document.getElementById('dashboardSidebar');
            const dashPageEl = document.getElementById('dashboardPage');
            const detailEl = document.getElementById('detailContainer');

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á
            [listEl, calEl, dashSideEl, dashPageEl, detailEl].forEach(el => el?.classList.add('hidden'));

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π
            const buttons = {
                dashboard: document.getElementById('dashToggle'),
                list: document.getElementById('listToggle'),
                calendar: document.getElementById('calToggle')
            };
            Object.values(buttons).forEach(btn => {
                if (btn) btn.className = "p-2 md:p-2.5 bg-slate-100 dark:bg-slate-800 text-slate-600 rounded-xl transition-all";
            });
            if (buttons[view]) buttons[view].className = "p-2 md:p-2.5 bg-indigo-600 text-white rounded-xl transition-all shadow-md scale-105";

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏° View
            if (view === 'dashboard') {
                dashSideEl.classList.remove('hidden');
                dashPageEl.classList.remove('hidden');
                updateChart();
            } else if (view === 'calendar') {
                calEl.classList.remove('hidden');
                detailEl.classList.remove('hidden');
                if (calendar) calendar.render();
            } else {
                listEl.classList.remove('hidden');
                detailEl.classList.remove('hidden');
            }
        }

        function updateChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const trendCtx = document.getElementById('trendChart').getContext('2d');

            // --- ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° (‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà) ---
            const summary = getCategorySummary();
            const labels = Object.keys(summary);
            const dataValues = Object.values(summary);

            if (spendingChart) spendingChart.destroy();
            spendingChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#64748b'],
                        hoverOffset: 20,
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: c => ` ${c.label}: ${c.raw.toLocaleString()} ‡∏ø` } }
                    },
                    onClick: (evt, item) => {
                        if (item.length > 0) {
                            const selectedCategory = labels[item[0].index];
                            filterByCategory(selectedCategory);
                        }
                    }
                }
            });



            // --- ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô (‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° 7 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ---
            const recentData = [...allData]
                .filter(item => item.isApproved)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(-7);

            if (trendChart) trendChart.destroy();
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: recentData.map(i => {
                        const d = i.date.split('-');
                        return d.length > 2 ? `${d[2]}/${d[1]}` : i.date;
                    }),
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô',
                        data: recentData.map(i => i.grandTotal),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#6366f1'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { callback: v => v.toLocaleString() } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
            updateStatusCards();
            updateCategoryList();
        }

        function filterByCategory(cat) {
            displayLimit = 15; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏°‡∏ß‡∏î
            currentFilterData = allData.filter(r => r.category === cat);
            handleSearch();
            switchView('list');
        }

        function updateStatusCards() {
            let total = allData.length, pending = 0, approved = 0, rejected = 0, totalSpent = 0;
            allData.forEach(item => {
                const amount = parseFloat(item.grandTotal) || 0;
                if (item.isApproved) { approved++; totalSpent += amount; }
                else if (item.status === 'rejected') rejected++;
                else pending++;
            });
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏á‡πÉ‡∏ô ID ‡∏ï‡πà‡∏≤‡∏á‡πÜ
            if (document.getElementById('statTotal')) document.getElementById('statTotal').innerText = total;
            if (document.getElementById('statPending')) document.getElementById('statPending').innerText = pending;
            if (document.getElementById('statApproved')) document.getElementById('statApproved').innerText = approved;
            if (document.getElementById('statRejected')) document.getElementById('statRejected').innerText = rejected;
            if (document.getElementById('sideStatPending')) document.getElementById('sideStatPending').innerText = pending;
            if (document.getElementById('totalSpentDisplay')) {
                document.getElementById('totalSpentDisplay').innerText = totalSpent.toLocaleString('th-TH', { minimumFractionDigits: 2 }) + " ‡∏ø";
            }
        }

        function updateCategoryList() {
            const summary = getCategorySummary();
            const container = document.getElementById('categoryListContainer');
            if (!container) return;
            container.innerHTML = '';
            const sorted = Object.entries(summary).sort((a, b) => b[1] - a[1]);
            sorted.forEach(([cat, amount]) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-all cursor-pointer group";
                div.onclick = () => filterByCategory(cat);
                div.innerHTML = `
            <div class="flex items-center gap-2">
                <div class="w-1.5 h-1.5 rounded-full bg-indigo-500"></div>
                <span class="text-[13px] font-medium text-slate-600 dark:text-slate-400 group-hover:text-indigo-500">${cat}</span>
            </div>
            <span class="text-[13px] font-bold text-slate-700 dark:text-slate-200">${amount.toLocaleString()} ‡∏ø</span>
        `;
                container.appendChild(div);
            });
        }


        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Pending, Approved, etc.)
        function filterByStatus(status) {
            displayLimit = 15;
            if (status === 'all') currentFilterData = null;
            else if (status === 'pending') currentFilterData = allData.filter(r => !r.isApproved && r.status !== 'rejected');
            else if (status === 'approved') currentFilterData = allData.filter(r => r.isApproved);
            else if (status === 'rejected') currentFilterData = allData.filter(r => r.status === 'rejected');

            document.getElementById('searchInput').value = '';
            handleSearch();
            switchView('list');
        }

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel (CSV)
        function exportToCSV() {
            if (allData.length === 0) return;
            const headers = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", "‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå", "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", "‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];
            const rows = allData.map(r => [
                r.date, r.category, r.purpose, r.personInCharge, r.grandTotal,
                r.isApproved ? "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß" : (r.status === 'rejected' ? "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" : "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥")
            ]);
            const csvContent = "\uFEFF" + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Report_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }



        function renderDetail(data) {
            const isApp = data.isApproved;
            const isRej = data.status === 'rejected';
            let displayDateTime = `${data.date || ''}`;
            if (data.createdAt) {
                const dateObj = data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
                const day = dateObj.toLocaleDateString('th-TH');
                const time = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                displayDateTime = `${day} | ${time} ‡∏ô.`;
            }

            document.getElementById('detailContainer').innerHTML = `
        <div class="space-y-6 pb-20">
            <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800 shadow-sm">
                <div class="flex flex-col md:flex-row justify-between gap-4">
                    <div class="flex-1">
                        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tighter">${data.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</h2>
                        <p class="text-indigo-600 text-lg font-bold mt-1">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ${data.purpose || '-'}</p>
                        <div class="flex flex-wrap items-center gap-y-2 gap-x-4 pt-3 border-t border-slate-100 dark:border-slate-800 mt-3">
    <div class="flex items-center gap-1.5">
        <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        <span class="text-xs md:text-sm font-semibold text-slate-700 dark:text-slate-300">${data.personInCharge}</span>
    </div>
    <div class="flex items-center gap-1.5">
        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
        <span class="text-xs md:text-sm text-slate-500 dark:text-slate-400 font-medium">${displayDateTime}</span>
    </div>
</div>
                    </div>
                    <div class="md:text-right">
                        <p class="text-3xl md:text-4xl font-black text-indigo-600">${formatMoney(data.grandTotal)} ‡∏ø</p>
                        <div class="flex gap-2 mt-3 md:justify-end">
                            ${(!isApp && !isRej) ? `
                                <button onclick="updateStatus('${data.id}','approve')" class="flex-1 md:flex-none px-4 py-2 bg-emerald-600 text-white text-xs font-bold rounded-xl">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button onclick="updateStatus('${data.id}','reject')" class="flex-1 md:flex-none px-4 py-2 bg-red-600 text-white text-xs font-bold rounded-xl">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                            ` : `<button onclick="resetStatus('${data.id}')" class="text-[10px] font-bold text-slate-400 border px-3 py-1 rounded-lg">Reset Status</button>`}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-slate-900 rounded-3xl border dark:border-slate-800 overflow-hidden shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse table-auto">
                        <thead class="bg-slate-50 dark:bg-slate-800 text-xs md:text-sm font-bold text-slate-600 dark:text-slate-300 border-b dark:border-slate-800">
                            <tr>
                                <th class="p-3 md:p-4 whitespace-nowrap text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th class="p-3 md:p-4 whitespace-nowrap text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th class="p-3 md:p-4 whitespace-nowrap text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                <th class="p-3 md:p-4 whitespace-nowrap text-right">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th>
                                <th class="p-3 md:p-4 whitespace-nowrap text-right">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                            ${data.items.map(i => `
                                <tr class="text-sm md:text-base hover:bg-slate-50/50 dark:hover:bg-slate-800/50 transition-colors">
                                    <td class="p-3 md:p-4 font-semibold text-slate-700 dark:text-slate-200 min-w-[140px] text-left">
                                        <div class="break-words line-clamp-2">${i.name}</div>
                                    </td>
                                    <td class="p-3 md:p-4 font-medium text-right">${i.qty}</td>
                                    <td class="p-3 md:p-4 whitespace-nowrap text-right">${formatMoney(i.price)}</td>
                                    <td class="p-3 md:p-4 text-red-500 whitespace-nowrap text-right">
                                        ${i.discount > 0 ? `-${formatMoney(i.discount)}` : '-'}
                                    </td>
                                    <td class="p-3 md:p-4 text-right font-black text-indigo-600 dark:text-indigo-400 whitespace-nowrap">
                                        ${formatMoney((i.price * i.qty) - (i.discount || 0))}
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800 text-center">
                    <p class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</p>
                    <img src="${data.signatureData}" class="max-h-24 mx-auto dark:invert">
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800">
                    <p class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest text-center">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</p>
                    <div class="flex gap-2 overflow-x-auto pb-2 justify-center">
                        ${data.receiptImages ? data.receiptImages.map(img => `<img src="${img}" onclick="openImage(this.src)" class="h-sm w-sm object-cover rounded-xl border cursor-zoom-in">`).join('') : '<p class="text-xs text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</p>'}
                    </div>
                </div>
            </div>
        </div>`;
        }

        async function updateStatus(id, action) {
            const isApp = action === 'approve';
            try {
                await db.collection('expenseReceipts').doc(id).update({
                    isApproved: isApp,
                    status: isApp ? 'approved' : 'rejected'
                });
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á render ‡πÄ‡∏≠‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ onSnapshot ‡πÉ‡∏ô setupListener ‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                showToast(isApp ? "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß" : "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß");
            } catch (error) {
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
            }
        }

        async function resetStatus(id) {
            await db.collection('expenseReceipts').doc(id).update({ isApproved: false, status: 'pending' });
            Toastify({ text: "Reset", background: "#6366f1", gravity: "bottom" }).showToast();
        }

        function openImage(s) { document.getElementById('modalImg').src = s; document.getElementById('imageModal').classList.remove('hidden'); }
        function closeImage() { document.getElementById('imageModal').classList.add('hidden'); }
        const formatMoney = (n) => parseFloat(n || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 });

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            const iconBtn = document.getElementById('themeIcon');
            iconBtn.innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function togglePasswordVisibility() {
            const pwdInput = document.getElementById('loginPassword');
            const eyeIcon = document.getElementById('eyeIcon');
            if (pwdInput.type === 'password') {
                pwdInput.type = 'text';
                eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />`;
            } else {
                pwdInput.type = 'password';
                eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />`;
            }
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !document.getElementById('loginOverlay').classList.contains('hidden')) handleLogin();
        });

        function getCategorySummary() {
            const summary = {};

            allData.forEach(item => {
                // ‡πÉ‡∏ä‡πâ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏
                const cat = item.category || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                const amount = parseFloat(item.grandTotal) || 0;

                // ‡πÄ‡∏£‡∏≤‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ
                // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å
                if (!summary[cat]) {
                    summary[cat] = 0;
                }
                summary[cat] += amount;
            });

            return summary;
        }

        let notifications = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        let isFirstLoad = true; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        function addNotification(data) {
            notifications.unshift(data); // ‡πÄ‡∏≠‡∏≤‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î
            updateNotifyUI();

            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Toastify (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢)
            showToast(`üîî ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å: ${data.personInCharge}`);

            // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ (Option)
            // new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play();
        }

        function showToast(message) {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "bottom",
                position: "right",
                style: {
                    background: "linear-gradient(to right, #4f46e5, #818cf8)",
                    borderRadius: "12px",
                    fontWeight: "bold"
                }
            }).showToast();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Badge ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Dropdown
        function updateNotifyUI() {
            const badge = document.getElementById('notifyBadge');
            const list = document.getElementById('notifyList');

            if (notifications.length > 0) {
                badge.innerText = notifications.length;
                badge.classList.remove('hidden');

                list.innerHTML = notifications.map(n => `
            <div onclick="viewNotifyItem('${n.id}')" class="p-3 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer transition-colors border-l-4 border-l-indigo-500">
                <p class="text-xs font-bold text-slate-900 dark:text-white">${n.category} - ${formatMoney(n.grandTotal)} ‡∏ø</p>
                <p class="text-[10px] text-slate-500 font-medium">‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢: ${n.personInCharge}</p>
                <p class="text-[9px] text-indigo-500 mt-1">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
            </div>
        `).join('');
            } else {
                badge.classList.add('hidden');
                list.innerHTML = `<p class="p-6 text-center text-xs text-slate-400 font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p>`;
            }
        }

        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô
        function viewNotifyItem(id) {
            toggleNotifyDropdown(); // ‡∏õ‡∏¥‡∏î dropdown
            currentFilterData = null; // ‡∏•‡πâ‡∏≤‡∏á filter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            selectItem(id); // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            switchView('list'); // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ list

            // ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏ß
            notifications = notifications.filter(n => n.id !== id);
            updateNotifyUI();
        }

        function toggleNotifyDropdown() {
            document.getElementById('notifyDropdown').classList.toggle('hidden');
        }

        function clearNotify() {
            notifications = [];
            updateNotifyUI();
            document.getElementById('notifyDropdown').classList.add('hidden');
        }

        // ‡∏õ‡∏¥‡∏î Dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                document.getElementById('notifyDropdown').classList.add('hidden');
            }
        });
    </script>
</body>

</html>