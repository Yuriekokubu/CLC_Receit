<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer - ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ Real-Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="icon" href="favicon.png" type="image/png">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    boxShadow: {
                        '3xl': '0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 10px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>

<body class="min-h-screen font-sans flex flex-col items-center py-4 sm:py-8">

    <div class="max-w-7xl mx-auto w-full bg-white p-4 sm:p-6 md:p-8 lg:p-10 rounded-2xl shadow-3xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-purple-800 tracking-wide">
                Viewer ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (Real-Time)</h1>
            <p class="text-lg text-gray-600 mt-2">‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏à‡∏±‡∏Å‡∏£‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á (Children of Light Church)</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-md h-full">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                            d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 6a1 1 0 011-1h12a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6z"
                            clip-rule="evenodd"></path>
                    </svg>
                    ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </h2>
                <div id="receiptsList" class="space-y-6">
                    <p class="text-gray-500 italic text-center" id="fetchStatus">
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Real-Time...
                    </p>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white p-4 rounded-xl border border-gray-300 shadow-xl min-h-[500px]">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
                    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å <span id="receiptIdDisplay" class="text-sm font-normal text-gray-500 ml-2"></span>
                </h2>
                <div id="receiptDetailsContainer">
                    <p class="text-gray-500 italic text-center py-20">
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </p>
                </div>
            </div>
        </div>
    </div>


    <script>
        // START: FIREBASE CONFIGURATION AND INITIALIZATION
        const firebaseConfig = {
            apiKey: "AIzaSyCkiq5_IM-1-REojhiAOjDgF-aQI9LMhHk",
            authDomain: "clc-e-receit.firebaseapp.com",
            projectId: "clc-e-receit",
            storageBucket: "clc-e-receit.firebasestorage.app",
            messagingSenderId: "578514019900",
            appId: "1:578514019900:web:998f3e9fa3b599a2344539",
            measurementId: "G-S65X8N123G"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // END: FIREBASE CONFIGURATION AND INITIALIZATION


        // Utility Functions
        const formatMoney = (amount) => parseFloat(amount || 0).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤';
            const dateObj = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return dateObj.toLocaleDateString('th-TH', {
                day: '2-digit',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        };

        const showMessage = (msg, isError = false) => {
            Toastify({
                text: msg,
                duration: 5000,
                close: true,
                gravity: "bottom",
                position: "center",
                backgroundColor: isError ? "rgba(239, 68, 68, 0.9)" : "rgba(34, 197, 94, 0.9)",
                stopOnFocus: true,
            }).showToast();
        };

        let selectedReceiptId = null;

        document.addEventListener('DOMContentLoaded', () => {
            setupRealtimeListener(); // Start listening on load
        });


        // --- FIRESTORE REAL-TIME LISTENER ---

        const setupRealtimeListener = () => {
            const statusElement = document.getElementById('fetchStatus');
            const listContainer = document.getElementById('receiptsList');

            statusElement.innerHTML = '<p class="text-center"><svg class="animate-spin h-5 w-5 text-purple-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>';

            db.collection('expenseReceipts')
                .orderBy('createdAt', 'desc')
                .limit(10) // ‡∏î‡∏∂‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                .onSnapshot((querySnapshot) => {
                    const approvedReceipts = [];
                    const pendingReceipts = [];

                    querySnapshot.forEach((doc) => {
                        const receipt = {
                            id: doc.id,
                            ...doc.data()
                        };

                        // Grouping
                        if (receipt.isApproved) {
                            approvedReceipts.push(receipt);
                        } else {
                            pendingReceipts.push(receipt);
                        }
                    });

                    renderGroupedReceiptsList(pendingReceipts, approvedReceipts, listContainer);

                    statusElement.innerHTML = `<p class="text-sm text-gray-500 italic text-center">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatTimestamp(new Date())}</p>`;

                    // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    if (!selectedReceiptId && (pendingReceipts.length > 0 || approvedReceipts.length > 0)) {
                        const firstReceipt = pendingReceipts.length > 0 ? pendingReceipts[0] : approvedReceipts[0];
                        viewReceiptDetails(firstReceipt.id, firstReceipt);
                    } else if (selectedReceiptId) {
                        // Re-render details of the currently selected one to reflect real-time changes
                        const currentData = [...pendingReceipts, ...approvedReceipts].find(r => r.id === selectedReceiptId);
                        if (currentData) {
                            renderReceiptDetails(currentData);
                        } else {
                            // If selected receipt disappeared from the list (e.g., limit(10) pushed it out)
                            // We should still try to fetch its details directly.
                            viewReceiptDetails(selectedReceiptId, null, false);
                        }
                    }

                }, (error) => {
                    console.error("Error setting up real-time listener: ", error);
                    statusElement.textContent = "üö® ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Real-Time";
                    showMessage("üö® ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Real-Time", true);
                });
        };


        const renderGroupedReceiptsList = (pending, approved, container) => {
            container.innerHTML = ''; // Clear existing content

            // --- 1. Pending Section ---
            container.innerHTML += `
                <div class="border-b-4 border-red-400 pb-3">
                    <h3 class="font-extrabold text-red-700 text-lg mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                        ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (${pending.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                    </h3>
                    <div class="space-y-3" id="pendingList">
                        ${pending.length > 0 ? pending.map(receipt => renderReceiptCard(receipt)).join('') : '<p class="text-sm text-gray-500 italic pl-6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>'}
                    </div>
                </div>
            `;

            // --- 2. Approved Section ---
            container.innerHTML += `
                <div class="border-b-4 border-green-400 pt-3">
                    <h3 class="font-extrabold text-green-700 text-lg mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (${approved.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                    </h3>
                    <div class="space-y-3 opacity-80" id="approvedList">
                        ${approved.length > 0 ? approved.map(receipt => renderReceiptCard(receipt)).join('') : '<p class="text-sm text-gray-500 italic pl-6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>'}
                    </div>
                </div>
            `;
        }

        const renderReceiptCard = (receipt) => {
            const dateStr = formatTimestamp(receipt.createdAt);
            const totalAmount = formatMoney(receipt.grandTotal || 0);
            const isActive = selectedReceiptId === receipt.id;
            const cardClass = isActive ? 'bg-purple-200 border-purple-600 border-2' : 'bg-white border border-gray-200 hover:bg-gray-100';

            return `
                <div onclick="viewReceiptDetails('${receipt.id}')"
                    class="p-3 rounded-lg shadow cursor-pointer transition duration-150 ${cardClass}">
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-base ${isActive ? 'text-purple-900' : 'text-blue-800'} overflow-hidden whitespace-nowrap text-ellipsis" title="${receipt.category || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'}">
                            ${receipt.category || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'}
                        </p>
                        <p class="text-sm font-semibold ${isActive ? 'text-purple-900' : 'text-red-600'}">
                            ${totalAmount}
                        </p>
                    </div>
                    <p class="text-xs text-gray-700 mt-1">
                        <span class="font-medium">${receipt.personInCharge || '-'}</span> | <span class="text-xs">${dateStr}</span>
                    </p>
                </div>
            `;
        }


        // --- DETAIL VIEW FUNCTIONS ---

        const viewReceiptDetails = async (receiptId, initialData = null, reRenderList = true) => {
            const detailsContainer = document.getElementById('receiptDetailsContainer');
            const idDisplay = document.getElementById('receiptIdDisplay');
            selectedReceiptId = receiptId;

            if (reRenderList) {
                // Setting selectedReceiptId and letting the real-time listener re-render the list for highlight
            }

            idDisplay.textContent = `(ID: ${receiptId})`;
            detailsContainer.innerHTML = '<p class="text-center py-20 text-purple-600"><svg class="animate-spin h-6 w-6 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...</p>';

            try {
                let dataToRender;
                if (initialData) {
                    dataToRender = initialData;
                } else {
                    // Fetch details directly if not passed (e.g., item pushed out of limit)
                    const doc = await db.collection('expenseReceipts').doc(receiptId).get();
                    if (doc.exists) {
                        dataToRender = { id: doc.id, ...doc.data() };
                    } else {
                        detailsContainer.innerHTML = '<p class="text-red-500 italic text-center py-20">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ID ‡∏ô‡∏µ‡πâ</p>';
                        return;
                    }
                }

                renderReceiptDetails(dataToRender);

            } catch (error) {
                console.error("Error fetching document details: ", error);
                detailsContainer.innerHTML = '<p class="text-red-500 italic text-center py-20">üö® ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>';
                showMessage("üö® ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", true);
            }
        };

        const approveReceipt = async (receiptId) => {
            if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ")) return;

            const button = document.getElementById('approveBtn');
            button.disabled = true;
            button.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
            button.classList.remove('bg-red-600', 'hover:bg-red-700');
            button.classList.add('bg-gray-500', 'cursor-not-allowed');

            try {
                await db.collection('expenseReceipts').doc(receiptId).update({
                    isApproved: true,
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° approvedBy: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Login
                });

                showMessage("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥", false);
                // Real-time listener ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderReceiptDetails ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

            } catch (error) {
                console.error("Error approving document: ", error);
                showMessage("üö® ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: " + error.message, true);

                // Reset button state on error
                if (button) {
                    button.disabled = false;
                    button.textContent = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å';
                    button.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    button.classList.add('bg-red-600', 'hover:bg-red-700');
                }
            }
        };


        const renderReceiptDetails = (data) => {
            const detailsContainer = document.getElementById('receiptDetailsContainer');

            // 1. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (from input field: YYYY-MM-DD)
            const dateObj = data.date ? new Date(data.date) : new Date();
            const expenseDateStr = dateObj.toLocaleDateString('th-TH', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });

            // 2. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (from Firestore Timestamp)
            const createdDateStr = formatTimestamp(data.createdAt);

            // 3. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô HTML ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
            const isApproved = data.isApproved || false;
            let approvalStatusHtml;
            let approvalInfoHtml;

            if (isApproved) {
                const approvedDateStr = formatTimestamp(data.approvedAt);

                approvalStatusHtml = `
            <span class="bg-green-100 text-green-800 text-lg font-extrabold px-3 py-1 rounded-full flex items-center shadow-lg">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
            </span>
        `;
                approvalInfoHtml = `<p class="mt-2 text-sm text-gray-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${approvedDateStr}</p>`;
            } else {
                approvalStatusHtml = `
            <button onclick="approveReceipt('${data.id}')" id="approveBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition duration-150 transform hover:scale-105">
                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.103a2.007 2.007 0 00-2.835-2.835L6 17.169V19.99h2.828l12.835-12.835z"></path></svg>
                ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å
            </button>
        `;
                approvalInfoHtml = `<p class="mt-2 text-sm text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>`;
            }


            // Itemized Table
            let itemTableHtml = data.items && data.items.length > 0 ? data.items.map((item, index) => {
                const qty = item.qty || '';
                const price = item.price || '';
                const discount = item.discount || 0;

                if (item.name.trim() === '' && item.total === 0) return '';
                return `
            <tr class="border-b">
                <td class="px-2 py-1 text-center">${index + 1}</td>
                <td class="px-2 py-1">${item.name || '-'}</td>
                <td class="px-2 py-1 text-right">${qty}</td>
                <td class="px-2 py-1 text-right">${price ? formatMoney(price) : '-'}</td>
                <td class="px-2 py-1 text-right text-red-600">${discount > 0 ? formatMoney(discount) : '-'}</td>
                <td class="px-2 py-1 text-right font-semibold">${formatMoney(item.total)}</td>
            </tr>
        `;
            }).join('') : '<tr><td colspan="6" class="text-center py-4 text-gray-500 italic">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</td></tr>';

            // Receipt Images
            let imageHtml = '';
            if (data.receiptImages && data.receiptImages.length > 0) {
                imageHtml = data.receiptImages.map((imgBase64, index) => `
            <div class="p-2 border border-gray-300 rounded-lg shadow-md bg-white">
                <p class="text-sm font-medium text-gray-600 mb-1">‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà ${index + 1}</p>
                <img src="${imgBase64}" alt="Receipt Image ${index + 1}" class="w-full h-auto object-contain max-h-96 rounded" loading="lazy">
            </div>
        `).join('');
            } else {
                imageHtml = '<p class="text-gray-500 italic">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏•‡∏¥‡∏õ/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</p>';
            }

            // Signature
            const signatureHtml = data.signatureData ? `
        <div class="p-4 border border-gray-300 rounded-lg shadow-inner bg-white max-w-sm mx-auto">
            <p class="text-sm font-medium text-gray-600 mb-1 text-center">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</p>
            <img src="${data.signatureData}" alt="Signature" class="w-full h-auto object-contain" style="max-height: 120px;">
            <p class="font-bold text-center mt-2">${data.personInCharge || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
        </div>
    ` : '<p class="text-gray-500 italic text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</p>';


            detailsContainer.innerHTML = `
        <div class="space-y-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-purple-100 rounded-lg border border-purple-300 shadow-md">
                <div class="text-left mb-3 sm:mb-0">
                    <p class="text-sm font-semibold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢:</p>
                    ${approvalStatusHtml}
                    ${approvalInfoHtml}
                </div>
                <div class="text-right">
                    <span class="text-gray-700 block font-semibold text-base">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span>
                    <span class="text-red-700 text-3xl font-extrabold">${formatMoney(data.grandTotal)} ‡∏ö‡∏≤‡∏ó</span>
                </div>
            </div>

            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h3 class="text-lg font-bold text-blue-800 mb-4 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-3">
                    <div>
                        <p>
                            <span class="font-semibold text-gray-700 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢:</span>
                            <span class="font-bold text-gray-800">${expenseDateStr}</span>
                        </p>
                        <p class="mt-2">
                            <span class="font-semibold text-gray-700 block">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</span>
                            <span class="font-bold text-gray-800">${data.category || '-'}</span>
                        </p>
                        <p class="mt-2">
                            <span class="font-semibold text-gray-700 block">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö/‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</span>
                            <span class="font-bold text-gray-800">${data.personInCharge || '-'}</span>
                        </p>
                    </div>
                    <div>
                        <p>
                            <span class="font-semibold text-gray-700 block">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span>
                            <span class="font-bold text-gray-800 text-sm">${createdDateStr}</span>
                        </p>
                        <p class="mt-2">
                            <span class="font-semibold text-gray-700 block">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</span>
                            <span class="font-bold text-gray-800">${data.purpose || '-'}</span>
                        </p>
                        <p class="mt-2 text-sm text-gray-500 italic">
                            ID: ${data.id}
                        </p>
                    </div>
                </div>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mt-6 border-b pb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á</h3>
            <div class="overflow-x-auto rounded-lg border border-gray-300 shadow-md">
                <table class="min-w-full bg-white text-sm">
                    <thead class="bg-gray-100 text-gray-700">
                        <tr>
                            <th class="px-2 py-2 text-center w-12">#</th>
                            <th class="px-2 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="px-2 py-2 text-right w-20">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th class="px-2 py-2 text-right w-24">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th class="px-2 py-2 text-right w-24">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th>
                            <th class="px-2 py-2 text-right w-28">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemTableHtml}
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-200 font-bold border-t-2 border-red-500">
                            <td colspan="5" class="px-4 py-2 text-right text-lg">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                            <td class="px-4 py-2 text-right text-xl text-red-700">${formatMoney(data.grandTotal)}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mt-6 pt-4 border-t border-gray-200">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</h3>
            ${signatureHtml}

            <h3 class="text-xl font-bold text-gray-800 mt-6 pt-4 border-t border-gray-200">‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${imageHtml}
            </div>
        </div>
    `;
        }

    </script>
</body>

</html>