<!DOCTYPE html>
<html lang="th" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLC Finance - Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Sarabun:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Poppins', 'Sarabun', 'sans-serif'] } } }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', 'Sarabun', sans-serif;
        }

        /* Modern Loading Animation */
        .loader-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .loader-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: loader-rotate 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        .loader-ring:nth-child(2) {
            border-top-color: #a855f7;
            animation-delay: -0.3s;
        }

        .loader-ring:nth-child(3) {
            border-top-color: #ec4899;
            animation-delay: -0.6s;
        }

        @keyframes loader-rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .sidebar-active {
            background-color: #f1f5f9;
            border-right: 4px solid #4f46e5;
        }

        .dark .sidebar-active {
            background-color: #1e293b;
            border-right-color: #818cf8;
        }

        .status-pending {
            border-left: 5px solid #f59e0b;
        }

        .status-approved {
            border-left: 5px solid #10b981;
        }

        .status-rejected {
            border-left: 5px solid #ef4444;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[100] hidden flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-white p-10 rounded-2xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center mb-6 text-slate-900">ADMIN LOGIN</h2>
            <div class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email"
                    class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-600 text-slate-900">

                <div class="relative">
                    <input type="password" id="loginPassword" placeholder="Password"
                        class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-600 text-slate-900">
                    <button type="button" onclick="togglePasswordVisibility()"
                        class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-indigo-600 transition">
                        <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>

                <button onclick="handleLogin()"
                    class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-black transition shadow-lg uppercase">Sign
                    In</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay"
        class="fixed inset-0 bg-white/95 dark:bg-slate-950/95 z-[60] flex items-center justify-center backdrop-blur-md">
        <div class="flex flex-col items-center">
            <div class="loader-container mb-4">
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
            </div>
            <p class="font-bold text-indigo-600 animate-pulse text-sm tracking-widest uppercase">Initializing App...</p>
        </div>
    </div>

    <div id="mainContent" class="hidden flex flex-col h-full">
        <header
            class="bg-white dark:bg-slate-900 border-b dark:border-slate-800 px-4 md:px-6 py-4 flex justify-between items-center z-50 shadow-sm">
            <div class="flex items-center gap-3">
                <button id="backBtn" onclick="toggleMobileList()"
                    class="md:hidden p-2 bg-slate-100 dark:bg-slate-800 rounded-lg hidden">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1
                    class="font-bold text-base md:text-xl tracking-tight uppercase truncate max-w-[120px] md:max-w-none">
                    CLC ADMIN</h1>
            </div>
            <div class="flex items-center gap-1.5 md:gap-2">
                <button onclick="switchView('dashboard')" id="dashToggle"
                    class="p-2 md:p-2.5 bg-slate-100 dark:bg-slate-800 rounded-xl transition-all hover:scale-105"
                    title="Dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H18a2.25 2.25 0 0 1-2.25-2.25v-2.25Z" />
                    </svg>
                </button>

                <button onclick="switchView('list')" id="listToggle"
                    class="p-2 md:p-2.5 bg-indigo-600 text-white rounded-xl transition-all hover:scale-105"
                    title="List View">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                    </svg>
                </button>

                <button onclick="switchView('calendar')" id="calToggle"
                    class="p-2 md:p-2.5 bg-slate-100 dark:bg-slate-800 rounded-xl transition-all hover:scale-105"
                    title="Calendar View">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
                    </svg>
                </button>

                <div class="w-px h-6 bg-slate-200 dark:bg-slate-800 mx-1"></div>

                <button id="themeIcon" onclick="toggleDarkMode()"
                    class="p-2 text-xl hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">üåô</button>

                <button onclick="handleLogout()"
                    class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden relative" id="appBody">
            <aside id="sidebarArea"
                class="absolute inset-y-0 left-0 z-20 w-full md:relative md:translate-x-0 md:w-[380px] bg-white dark:bg-slate-900 border-r dark:border-slate-800 flex flex-col transition-transform duration-300">
                <div id="listView" class="flex flex-col h-full">
                    <div class="p-4 border-b dark:border-slate-800">
                        <input type="text" id="searchInput" oninput="handleSearch()"
                            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà, ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå..."
                            class="w-full p-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl outline-none focus:ring-2 focus:ring-indigo-600 text-sm font-medium">
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll" id="receiptsList"></div>
                </div>

                <div id="calendarView"
                    class="hidden flex flex-col h-full p-3 overflow-y-auto bg-white dark:bg-slate-900">
                    <div id='calendar' class="text-xs"></div>
                </div>
            </aside>

            <main class="flex-1 bg-slate-50 dark:bg-slate-950 overflow-y-auto custom-scroll p-4 md:p-8 w-full">
                <div id="dashboardPage" class="hidden max-w-5xl mx-auto space-y-6">
                    <h2 class="text-2xl font-bold">Financial Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800 shadow-sm">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 text-center">
                                ‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</p>
                            <div class="h-64"><canvas id="categoryChart"></canvas></div>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800 shadow-sm flex flex-col justify-center items-center">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </p>
                            <p id="totalSpentDisplay" class="text-4xl md:text-5xl font-black text-indigo-600">0.00 ‡∏ø</p>
                        </div>
                    </div>
                </div>

                <div id="detailContainer" class="max-w-5xl mx-auto h-full">
                    <div
                        class="h-full flex flex-col items-center justify-center text-slate-400 border-2 border-dashed rounded-3xl border-slate-200 dark:border-slate-800 opacity-40">
                        <p class="text-xs font-bold tracking-widest text-center px-4">SELECT A RECORD TO VIEW DETAILS
                        </p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="imageModal"
        class="fixed inset-0 bg-slate-950/90 z-[200] hidden flex items-center justify-center p-8 backdrop-blur-md"
        onclick="closeImage()">
        <img id="modalImg" class="max-w-full max-h-full rounded-xl shadow-2xl" src="">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCkiq5_IM-1-REojhiAOjDgF-aQI9LMhHk",
            authDomain: "clc-e-receit.firebaseapp.com",
            projectId: "clc-e-receit",
            storageBucket: "clc-e-receit.firebasestorage.app",
            messagingSenderId: "578514019900",
            appId: "1:578514019900:web:998f3e9fa3b599a2344539"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let allData = [];
        let selectedId = null;
        let calendar = null;
        let spendingChart = null;

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Refresh ---
        auth.onAuthStateChanged(user => {
            const loginOverlay = document.getElementById('loginOverlay');
            const mainContent = document.getElementById('mainContent');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if (user) {
                // ‡∏ñ‡πâ‡∏≤ Login ‡πÅ‡∏•‡πâ‡∏ß: ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                loginOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');

                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                setupListener();
                initCalendar();
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login: ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                loginOverlay.classList.remove('hidden');
                mainContent.classList.add('hidden');

                // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Loading ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ
                loadingOverlay.classList.add('hidden');
            }
        });

        async function handleLogin() {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPassword').value;
            try {
                await auth.signInWithEmailAndPassword(e, p);
            } catch (err) {
                alert("Login Failed: " + err.message);
            }
        }

        function handleLogout() {
            auth.signOut();
        }

        function setupListener() {
            db.collection('expenseReceipts').orderBy('createdAt', 'desc').onSnapshot(snap => {
                allData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                handleSearch();
                updateCalendarEvents();

                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Loading
                document.getElementById('loadingOverlay').classList.add('hidden');

                if (selectedId) {
                    const item = allData.find(r => r.id === selectedId);
                    if (item) renderDetail(item);
                }
            });
        }

        function handleSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(i =>
                (i.personInCharge?.toLowerCase().includes(term)) ||
                (i.category?.toLowerCase().includes(term)) ||
                (i.date?.includes(term)) ||
                (i.purpose?.toLowerCase().includes(term))
            );
            renderList(filtered);
        }

        function renderList(items) {
            const container = document.getElementById('receiptsList');
            const approved = items.filter(r => r.isApproved === true);
            const rejected = items.filter(r => r.status === 'rejected');
            const pending = items.filter(r => r.isApproved !== true && r.status !== 'rejected');

            const createSection = (title, list, textColor) => {
                if (list.length === 0) return '';

                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤)
                let headerBg, badgeColor;
                if (title.includes('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')) {
                    headerBg = 'bg-amber-500';
                    badgeColor = 'text-amber-600';
                } else if (title.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß')) {
                    headerBg = 'bg-emerald-500';
                    badgeColor = 'text-emerald-600';
                } else {
                    headerBg = 'bg-red-500';
                    badgeColor = 'text-red-600';
                }

                return `
        <div class="sticky top-0 z-10 px-4 py-2 ${headerBg} shadow-md">
            <div class="flex items-center justify-between">
                <span class="text-white text-lg font-black tracking-wider">${title}</span>
                <span class="bg-white/90 px-3 py-0.5 rounded-full text-sm font-black ${badgeColor}">
                    ${list.length}
                </span>
            </div>
        </div>

        ${list.map(r => {
                    const sClass = r.isApproved ? 'status-approved' : (r.status === 'rejected' ? 'status-rejected' : 'status-pending');
                    const isActive = selectedId === r.id ? 'bg-indigo-50 dark:bg-indigo-900/40 ring-2 ring-indigo-500 z-[5]' : 'bg-white dark:bg-slate-900';

                    return `
                <div onclick="selectItem('${r.id}')" 
                     class="relative p-3 border-b dark:border-slate-800 cursor-pointer transition-all 
                            hover:bg-slate-50 dark:hover:bg-slate-800 ${isActive} ${sClass}">
                    
                    <div class="flex justify-between items-center">
                        <div class="flex-1 truncate pr-2">
                            <h3 class="text-lg font-extrabold text-slate-900 dark:text-white truncate leading-tight">
                                ${r.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}
                            </h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 font-bold truncate">
                                ${r.purpose || '-'}
                            </p>
                        </div>
                        
                        <div class="text-right">
                            <span class="text-lg font-black text-indigo-600 dark:text-indigo-400">
                                ${formatMoney(r.grandTotal)}
                            </span>
                            <div class="text-[10px] font-bold text-slate-400 uppercase leading-none">
                                ${r.personInCharge}
                            </div>
                        </div>
                    </div>

                    ${selectedId === r.id ? `
                        <div class="absolute inset-y-0 left-0 w-1.5 bg-indigo-600"></div>
                    ` : ''}
                </div>`;
                }).join('')}
    `;
            };
            container.innerHTML = createSection('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', pending, 'text-amber-500') +
                createSection('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', approved, 'text-emerald-500') +
                createSection('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', rejected, 'text-red-500');
        }

        function updateChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const summary = {};
            let total = 0;
            allData.forEach(r => {
                const cat = r.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                summary[cat] = (summary[cat] || 0) + (r.grandTotal || 0);
                total += (r.grandTotal || 0);
            });
            document.getElementById('totalSpentDisplay').innerText = total.toLocaleString('th-TH', { minimumFractionDigits: 2 }) + " ‡∏ø";
            if (spendingChart) spendingChart.destroy();
            spendingChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(summary),
                    datasets: [{
                        data: Object.values(summary),
                        backgroundColor: ['#6366f1', '#a855f7', '#ec4899', '#f59e0b', '#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
            });
        }

        function initCalendar() {
            const calEl = document.getElementById('calendar');
            if (!calEl) return;
            calendar = new FullCalendar.Calendar(calEl, {
                initialView: 'dayGridMonth', locale: 'th', height: 'auto',
                dateClick: (info) => {
                    document.getElementById('searchInput').value = info.dateStr;
                    handleSearch();
                    switchView('list');
                },
                eventContent: (arg) => {
                    let h = `<div class="flex gap-1">`;
                    if (arg.event.extendedProps.p > 0) h += `<span class="px-1 bg-amber-500 text-white text-[9px] rounded">${arg.event.extendedProps.p}</span>`;
                    if (arg.event.extendedProps.a > 0) h += `<span class="px-1 bg-emerald-500 text-white text-[9px] rounded">${arg.event.extendedProps.a}</span>`;
                    if (arg.event.extendedProps.r > 0) h += `<span class="px-1 bg-red-500 text-white text-[9px] rounded">${arg.event.extendedProps.r}</span>`;
                    return { html: h + `</div>` };
                }
            });
        }

        function updateCalendarEvents() {
            if (!calendar) return;
            const groups = {};
            allData.forEach(r => {
                if (!groups[r.date]) groups[r.date] = { p: 0, a: 0, r: 0 };
                if (r.isApproved) groups[r.date].a++; else if (r.status === 'rejected') groups[r.date].r++; else groups[r.date].p++;
            });
            calendar.removeAllEvents();
            calendar.addEventSource(Object.keys(groups).map(d => ({
                start: d, allDay: true, extendedProps: groups[d], backgroundColor: 'transparent', borderColor: 'transparent'
            })));
        }

        function selectItem(id) {
            selectedId = id;
            handleSearch();
            const item = allData.find(r => r.id === id);
            if (item) renderDetail(item);

            if (window.innerWidth < 768) {
                document.getElementById('sidebarArea').classList.add('-translate-x-full');
                document.getElementById('backBtn').classList.remove('hidden');
            }
        }

        function toggleMobileList() {
            document.getElementById('sidebarArea').classList.remove('-translate-x-full');
            document.getElementById('backBtn').classList.add('hidden');
        }

        function switchView(view) {
            const listEl = document.getElementById('listView');
            const calEl = document.getElementById('calendarView');
            const dashEl = document.getElementById('dashboardPage');
            const detailEl = document.getElementById('detailContainer');

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á
            [listEl, calEl, dashEl, detailEl].forEach(el => el.classList.add('hidden'));

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å class ‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô)
            document.querySelectorAll('header button[id*="Toggle"]').forEach(btn => {
                btn.className = "p-2 md:p-2.5 bg-slate-100 dark:bg-slate-800 rounded-xl transition-all hover:scale-105";
            });

            if (window.innerWidth < 768) toggleMobileList();

            if (view === 'dashboard') {
                dashEl.classList.remove('hidden');
                document.getElementById('dashToggle').className = "p-2 md:p-2.5 bg-indigo-600 text-white rounded-xl transition-all hover:scale-105";
                updateChart();
            } else if (view === 'calendar') {
                calEl.classList.remove('hidden');
                detailEl.classList.remove('hidden');
                document.getElementById('calToggle').className = "p-2 md:p-2.5 bg-indigo-600 text-white rounded-xl transition-all hover:scale-105";
                if (calendar) calendar.render();
            } else {
                listEl.classList.remove('hidden');
                detailEl.classList.remove('hidden');
                document.getElementById('listToggle').className = "p-2 md:p-2.5 bg-indigo-600 text-white rounded-xl transition-all hover:scale-105";
            }
        }

        function renderDetail(data) {
            const isApp = data.isApproved;
            const isRej = data.status === 'rejected';
            let displayDateTime = `${data.date || ''}`;
            if (data.createdAt) {
                const dateObj = data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
                const day = dateObj.toLocaleDateString('th-TH');
                const time = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                displayDateTime = `${day} | ${time} ‡∏ô.`;
            }

            document.getElementById('detailContainer').innerHTML = `
                <div class="space-y-6 pb-20">
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between gap-4">
                            <div class="flex-1">
                                <h2 class="text-2xl md:text-3xl font-extrabold tracking-tighter">${data.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</h2>
                                <p class="text-indigo-600 text-sm font-bold mt-1">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ${data.purpose || '-'}</p>
                                <p class="text-slate-500 text-xs md:text-sm pt-2">‡πÇ‡∏î‡∏¢: ${data.personInCharge} | ${displayDateTime}</p>
                            </div>
                            <div class="md:text-right">
                                <p class="text-3xl md:text-4xl font-black text-indigo-600">${formatMoney(data.grandTotal)} ‡∏ø</p>
                                <div class="flex gap-2 mt-3 md:justify-end">
                                    ${(!isApp && !isRej) ? `
                                        <button onclick="updateStatus('${data.id}','approve')" class="flex-1 md:flex-none px-4 py-2 bg-emerald-600 text-white text-xs font-bold rounded-xl">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                        <button onclick="updateStatus('${data.id}','reject')" class="flex-1 md:flex-none px-4 py-2 bg-red-600 text-white text-xs font-bold rounded-xl">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                    ` : `<button onclick="resetStatus('${data.id}')" class="text-[10px] font-bold text-slate-400 border px-3 py-1 rounded-lg">Reset Status</button>`}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-slate-900 rounded-3xl border dark:border-slate-800 overflow-hidden shadow-sm">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse table-auto">
            <thead class="bg-slate-50 dark:bg-slate-800 text-sm md:text-xl font-bold text-slate-600 dark:text-slate-300 border-b dark:border-slate-800">
                <tr>
                    <th class="p-3 md:p-4 whitespace-nowrap">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th class="p-3 md:p-4 text-center whitespace-nowrap w-16">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th class="p-3 md:p-4 text-center whitespace-nowrap">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th class="p-3 md:p-4 text-center whitespace-nowrap">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th>
                    <th class="p-3 md:p-4 text-right whitespace-nowrap">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                ${data.items.map(i => `
                    <tr class="text-base md:text-lg hover:bg-slate-50/50 dark:hover:bg-slate-800/50 transition-colors">
                        <td class="p-3 md:p-4 font-semibold text-slate-700 dark:text-slate-200 min-w-[140px]">
                            <div class="break-words line-clamp-2">${i.name}</div>
                        </td>
                        <td class="p-3 md:p-4 text-center font-medium">${i.qty}</td>
                        <td class="p-3 md:p-4 text-center whitespace-nowrap">${formatMoney(i.price)}</td>
                        <td class="p-3 md:p-4 text-center text-red-500 whitespace-nowrap">
                            ${i.discount > 0 ? `-${formatMoney(i.discount)}` : '-'}
                        </td>
                        <td class="p-3 md:p-4 text-right font-black text-indigo-600 dark:text-indigo-400 whitespace-nowrap">
                            ${formatMoney((i.price * i.qty) - (i.discount || 0))}
                        </td>
                    </tr>`).join('')}
            </tbody>
        </table>
    </div>
</div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800 text-center">
                            <p class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</p>
                            <img src="${data.signatureData}" class="max-h-24 mx-auto dark:invert">
                        </div>
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800">
                            <p class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest text-center">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</p>
                            <div class="flex gap-2 overflow-x-auto pb-2 justify-center">
                                ${data.receiptImages ? data.receiptImages.map(img => `<img src="${img}" onclick="openImage(this.src)" class="h-sm w-sm object-cover rounded-xl border cursor-zoom-in">`).join('') : '<p class="text-xs text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</p>'}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        async function updateStatus(id, a) {
            const isApp = a === 'approve';
            await db.collection('expenseReceipts').doc(id).update({ isApproved: isApp, status: isApp ? 'approved' : 'rejected' });
            Toastify({ text: "Success", background: isApp ? "#10b981" : "#ef4444", gravity: "bottom" }).showToast();
        }

        async function resetStatus(id) {
            await db.collection('expenseReceipts').doc(id).update({ isApproved: false, status: 'pending' });
            Toastify({ text: "Reset", background: "#6366f1", gravity: "bottom" }).showToast();
        }

        function openImage(s) { document.getElementById('modalImg').src = s; document.getElementById('imageModal').classList.remove('hidden'); }
        function closeImage() { document.getElementById('imageModal').classList.add('hidden'); }
        const formatMoney = (n) => parseFloat(n || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 });

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            const iconBtn = document.getElementById('themeIcon');
            iconBtn.innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function togglePasswordVisibility() {
            const pwdInput = document.getElementById('loginPassword');
            const eyeIcon = document.getElementById('eyeIcon');
            if (pwdInput.type === 'password') {
                pwdInput.type = 'text';
                eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />`;
            } else {
                pwdInput.type = 'password';
                eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />`;
            }
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !document.getElementById('loginOverlay').classList.contains('hidden')) handleLogin();
        });
    </script>
</body>

</html>