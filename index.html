<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ - ‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏à‡∏±‡∏Å‡∏£‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <script src="jspdf.umd.min.js"></script>
    <script src="html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="icon" href="favicon.png" type="image/png">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    boxShadow: {
                        '3xl': '0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 10px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Global Styles */
        body {
            font-family: 'Sarabun', sans-serif;
        }

        .bill-container {
            font-weight: 400;
        }

        /* Hide spinners in number inputs */
        .no-spinners::-webkit-outer-spin-button,
        .no-spinners::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .no-spinners {
            -moz-appearance: textfield;
        }

        /* Modal Styles */
        #pdfPreviewModal iframe {
            width: 100%;
            height: 80vh;
            border-radius: 0.75rem;
        }

        /* --- PDF TEMPLATE STYLES (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) --- */
        #pdfTemplate {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 800px;
            min-height: 1123px;
            background-color: white;
            box-sizing: border-box;
            color: #000;
        }

        .pdf-page-content {
            position: relative;
            width: 800px;
            min-height: 1123px;
            padding: 40px 50px;
            box-sizing: border-box;
            color: #000;
            background-color: white;
        }

        .pdf-page-content .pdf-logo {
            width: 70px;
            height: 70px;
            border: 3px solid #1e3a8a;
            border-radius: 50%;
            box-sizing: border-box;
            display: inline-block;
        }

        .template-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .template-table th {
            background-color: #f3f4f6;
            border: 1px solid #9ca3af;
            padding: 8px;
            text-align: center;
            font-weight: bold;
        }

        .template-table td {
            border: 1px solid #9ca3af;
            padding: 8px;
            vertical-align: top;
        }

        .template-header-line {
            border-bottom: 2px solid #1e3a8a;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .pdf-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 5em;
            color: #d1d5db;
            opacity: 0.3;
            z-index: -1;
            pointer-events: none;
            width: 100%;
            text-align: center;
            font-weight: 800;
            white-space: nowrap;
        }

        .header-logo-from-css {
            background-color: #ffffff;
            border-radius: 50%;
            box-shadow: 0 0 0 4px #bfdbfe, 0 0 0 6px #1e3a8a;
        }
    </style>
</head>

<body class="bg-[rgb(0,49,97)] min-h-screen font-sans flex flex-col items-center py-4 sm:py-8">

    <div class="max-w-7xl mx-auto w-full bg-white p-4 sm:p-6 md:p-8 lg:p-12 rounded-2xl shadow-3xl">
        <div id="billContent"
            class="bill-container p-3 sm:p-4 md:p-6 lg:p-8 border-4 border-gray-300 rounded-xl bg-white">

            <header class="text-center mb-6 sm:mb-8 md:mb-10">
                <div class="flex items-center justify-center mb-5 sm:mb-6">
                    <div class="header-logo-from-css w-16 h-16 sm:w-20 sm:h-20 mr-4 object-contain" alt="Church Logo"
                        title="Church Logo">
                    </div>

                    <h1 class="text-xl sm:text-4xl font-extrabold text-blue-900 tracking-wide">
                        ‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏à‡∏±‡∏Å‡∏£‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</h1>
                </div>
                <h2
                    class="text-xl sm:text-2xl font-bold text-gray-700 mb-4 inline-block border-b-2 border-blue-400 pb-2">
                    ‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á</h2>

                <div
                    class="flex flex-col sm:flex-row justify-between items-start w-full mt-4 mb-6 space-y-4 sm:space-y-0 sm:space-x-8">
                    <div class="flex items-center w-full sm:w-1/2">
                        <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</span>
                        <input id="billPurpose" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™..."
                            class="border-b-2 border-gray-400 p-1 text-base text-center sm:text-lg text-gray-800 focus:outline-none focus:border-blue-600 w-full bg-transparent">
                    </div>
                    <div class="flex items-center w-full sm:w-1/2">
                        <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</span>
                        <div class="relative w-full">
                            <select id="billCategory" onchange="handleCategoryChange(this.value)"
                                class="border-b-2 border-gray-400 p-1 text-base sm:text-lg text-gray-800 focus:outline-none focus:border-blue-600 w-full bg-transparent text-center font-bold transition-opacity duration-300">
                            </select>

                            <div id="customCategoryWrapper" class="absolute inset-0 hidden flex items-center">
                                <input id="customCategoryInput" type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏≠‡∏á..."
                                    class="border-b-2 border-blue-600 p-1 text-base sm:text-lg text-gray-800 focus:outline-none w-full bg-transparent text-center font-bold pr-8">
                                <button onclick="revertToCategorySelect()" title="‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
                                    class="absolute right-0 top-1/2 -translate-y-1/2 text-gray-500 hover:text-red-500 p-1 text-xl font-bold leading-none">
                                    &times;
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-8">
                    <div class="flex items-center w-full sm:w-1/2">
                        <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ:</span>
                        <input id="billDateDisplay" type="text" readonly
                            class="text-base sm:text-lg text-gray-800 focus:outline-none w-full bg-transparent text-center border-b-2 border-gray-400 p-1 font-bold">
                        <input id="billDate" type="hidden" value="">
                    </div>
                    <div class="flex items-center w-full sm:w-1/2">
                        <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</span>
                        <input id="personInCharge" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"
                            class="border-b-2 border-gray-400 p-1 text-base sm:text-lg text-gray-800 focus:outline-none focus:border-blue-600 w-full text-center bg-transparent">
                    </div>
                </div>
            </header>

            <div class="overflow-x-auto mb-10 shadow-lg rounded-lg border border-gray-300">
                <table class="min-w-full bg-white border-collapse">
                    <thead class="bg-blue-800 text-white">
                        <tr>
                            <th class="py-3 px-2 sm:px-4 text-left font-bold w-3/12 border-r border-blue-600">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                            </th>
                            <th class="py-3 px-2 sm:px-4 text-right font-bold w-1/12 border-r border-blue-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                            </th>
                            <th class="py-3 px-2 sm:px-4 text-right font-bold w-1/12 border-r border-blue-600">
                                ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th class="py-3 px-2 sm:px-4 text-right font-bold w-1/12 border-r border-blue-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
                                (‡∏ö‡∏≤‡∏ó)</th>
                            <th class="py-3 px-2 sm:px-4 text-right font-bold w-2/12 border-r border-blue-600">‡∏£‡∏ß‡∏°
                                (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î)</th>
                            <th class="py-3 px-2 sm:px-4 text-center font-bold w-1/12">‡∏•‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody id="itemTableBody" class="text-gray-700"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="py-3 px-4 text-right">
                                <button onclick="addItem()"
                                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow">
                                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                </button>
                            </td>
                        </tr>
                        <tr class="bg-gray-100 border-t-4 border-blue-600">
                            <td colspan="4" class="py-4 px-4 text-right font-extrabold text-blue-800 text-xl">
                                ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
                            </td>
                            <td id="grandTotal" class="py-4 px-4 text-right text-xl font-black text-blue-800">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200">
            <div class="flex flex-col lg:flex-row lg:space-x-4">

                <div class="lg:w-1/2 min-w-0 mb-8 lg:mb-0">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 inline-block mr-2 text-blue-500" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                            </path>
                        </svg>
                        ‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                    </h3>

                    <div class="bg-white p-6 rounded-xl border border-gray-300 shadow-xl">
                        <canvas id="signatureCanvas" width="400" height="200"
                            class="border-2 border-dashed border-gray-400 bg-white cursor-crosshair mx-auto block rounded-md"
                            style="touch-action: none;"></canvas>

                        <div class="mt-4 flex space-x-4 justify-center">
                            <button onclick="clearSignature()"
                                class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">
                                ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                            </button>
                            <button onclick="saveSignature()"
                                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                            </button>
                        </div>

                        <p class="text-sm text-gray-700 mt-3 text-center italic">
                            * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏¥‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô *
                        </p>
                    </div>
                </div>

                <div class="lg:w-1/2 flex flex-col">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        üìù ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å
                    </h3>
                    <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200 shadow-md flex-grow">
                        <ol class="list-none space-y-3 text-gray-700">
                            <li class="flex items-center"> <span
                                    class="text-lg font-extrabold text-blue-700 mr-3">1.</span>
                                <p class="font-medium">‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
                            </li>
                            <li class="flex items-center"> <span
                                    class="text-lg font-extrabold text-blue-700 mr-3">2.</span>
                                <p class="font-medium">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡∏∞‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
                            </li>
                            <li class="flex items-center"> <span
                                    class="text-lg font-extrabold text-blue-700 mr-3">3.</span>
                                <p class="font-medium flex items-center">
                                    <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                                        </path>
                                    </svg>
                                    ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡πâ ‡πÄ‡∏´‡∏£‡∏±‡∏ç‡∏ç‡∏¥‡∏Å‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏à‡∏±‡∏Å‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
                                </p>
                            </li>
                            <li class="flex items-center border-t pt-3 mt-3 border-blue-200"> <span
                                    class="text-lg font-extrabold text-red-600 mr-3">4.</span>
                                <p class="font-bold text-red-600">‡∏ô‡∏≥‡∏™‡∏•‡∏¥‡∏õ/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏≤‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)</p>
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
            <h3 class="text-xl font-bold text-gray-800 my-4 pt-4 border-t border-gray-200">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h3>

            <div id="uploadZone" onclick="document.getElementById('receiptImageInput').click()"
                class="p-6 sm:p-8 border-4 border-dashed border-green-500 rounded-2xl bg-green-50 text-center flex flex-col items-center transition duration-200 hover:bg-green-100 cursor-pointer">

                <svg class="w-12 h-12 text-green-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                <p class="text-lg font-semibold text-gray-700 mb-3">‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
                    5MB/‡πÑ‡∏ü‡∏•‡πå)</p>

                <input type="file" id="receiptImageInput" accept="image/*" multiple onchange="handleImageUpload(event)"
                    class="hidden" />

                <div id="receiptsPreviewContainer" class="mt-4 flex flex-wrap gap-4 justify-center w-full"></div>
            </div>

            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-6 mt-8">
                <button onclick="previewPDF()"
                    class="flex-1 bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-6 sm:py-4 sm:px-8 rounded-xl shadow-xl transition transform hover:scale-[1.02] text-base sm:text-lg">
                    ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß PDF
                </button>
                <button onclick="downloadPDF()"
                    class="flex-1 bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 sm:py-4 sm:px-8 rounded-xl shadow-xl transition transform hover:scale-[1.02] text-base sm:text-lg">
                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
                </button>
            </div>
        </div>
    </div>

    <div id="pdfTemplate"></div>


    <div id="pdfPreviewModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4"
        onclick="closeModal(event)">
        <div class="bg-white p-6 rounded-2xl shadow-3xl max-w-7xl w-full h-[95vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-bold text-gray-800">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF</h2>
                <button onclick="hideModal()"
                    class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
            </div>
            <iframe id="pdfIframe"></iframe>
        </div>
    </div>

    <script>
        let items = [];
        let receiptImages = [];
        let signatureData = null; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
        let hasDrawn = false; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const ITEMS_PER_FIRST_PAGE = 10;
        const ITEMS_PER_SUBSEQUENT_PAGE = 10;
        const CUSTOM_CATEGORY_KEY = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';

        // NEW FIX: Global variable to hold the currently generated Blob URL for cleanup
        let currentBlobUrl = null;
        // END NEW FIX

        // Define Category structure 
        const CATEGORIES = {
            '‡∏≠‡∏≤‡∏´‡∏≤‡∏£': ['‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£'],
            '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': ['‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'],
            '‡∏û‡∏±‡∏ô‡∏ò‡∏Å‡∏¥‡∏à': ['‡∏û‡∏±‡∏ô‡∏ò‡∏Å‡∏¥‡∏à‡πÄ‡∏î‡πá‡∏Å'],
            '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô/‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î': ['‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç', '‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', '‡∏´‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£', '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ']
        };

        // NEW: Function to populate the category dropdown
        const populateCategories = () => {
            const select = document.getElementById('billCategory');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>';

            for (const group in CATEGORIES) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group;
                CATEGORIES[group].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
        };


        // Utilities
        const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);
        const formatDate = (dateValue) => {
            if (!dateValue) return '';
            const dateObj = new Date(dateValue);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${day}/${month}/${year}`;
        };
        const formatMoney = (amount) => parseFloat(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Utility Functions for Message Box
        const showMessage = (msg, isError = true) => {
            Toastify({
                text: msg,
                duration: 5000,
                close: true,
                gravity: "bottom",
                position: "center",
                backgroundColor: isError ? "rgba(239, 68, 68, 0.9)" : "rgba(34, 197, 94, 0.9)",
                stopOnFocus: true,
            }).showToast();
        };

        // Removed hideMessage as Toastify handles it


        // --- START: CATEGORY HANDLER FUNCTIONS (from previous request) ---

        const getCurrentCategoryValue = () => {
            const select = document.getElementById('billCategory');
            const customInput = document.getElementById('customCategoryInput');
            const selectedValue = select.value.trim();

            if (selectedValue === CUSTOM_CATEGORY_KEY) {
                return customInput.value.trim() || '';
            }
            return selectedValue;
        };

        const handleCategoryChange = (selectedValue) => {
            const select = document.getElementById('billCategory');
            const customWrapper = document.getElementById('customCategoryWrapper');
            const customInput = document.getElementById('customCategoryInput');

            if (selectedValue === CUSTOM_CATEGORY_KEY) {
                select.classList.add('opacity-0', 'pointer-events-none', 'absolute', 'z-0');
                customWrapper.classList.remove('hidden');
                customInput.value = '';
                customInput.focus();
            } else {
                customWrapper.classList.add('hidden');
                select.classList.remove('opacity-0', 'pointer-events-none', 'absolute', 'z-0');
            }
        };

        const revertToCategorySelect = () => {
            const select = document.getElementById('billCategory');
            const customWrapper = document.getElementById('customCategoryWrapper');
            const customInput = document.getElementById('customCategoryInput');

            customInput.value = '';
            customWrapper.classList.add('hidden');
            select.classList.remove('opacity-0', 'pointer-events-none', 'absolute', 'z-0');
            select.value = '';
            select.focus();
        };

        // --- END: CATEGORY HANDLER FUNCTIONS ---


        // --- START: INPUT CLEANING FUNCTIONS (UPDATED for Decimal) ---

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏ö‡∏ß‡∏Å (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
         * @param {string} value ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å input
         * @param {number} decimalPlaces ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
         * @param {number} minValue ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏≠ 0)
         * @returns {string} ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏õ‡πá‡∏ô string)
         */
        const cleanDecimalInput = (value, decimalPlaces = 2) => {
            // ‡∏ß‡πà‡∏≤‡∏á = ‡∏ß‡πà‡∏≤‡∏á
            if (value === '') return '';

            // ‡πÅ‡∏ó‡∏ô , ‡πÄ‡∏õ‡πá‡∏ô .
            value = value.replace(/,/g, '.');

            // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡∏±‡∏ö .
            value = value.replace(/[^\d.]/g, '');

            // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï . ‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }

            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà parse
            if (value.includes('.')) {
                const [i, d] = value.split('.');
                value = i + '.' + d.slice(0, decimalPlaces);
            }

            return value;
        };



        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏ß‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
         * (‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Quantity ‡πÅ‡∏•‡πâ‡∏ß)
         * @param {string} value ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å input
         * @param {number} minValue ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏≠ 0)
         * @returns {string} ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏õ‡πá‡∏ô string)
         */
        const cleanNumberInput = (value, minValue = 0) => {
            if (value.trim() === '') {
                return '';
            }

            // 1. ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°)
            let num = Math.round(parseFloat(value) || 0);

            // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î
            if (num < minValue) {
                num = minValue;
            }

            return String(num);
        };

        // --- END: INPUT CLEANING FUNCTIONS ---


        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Focus/Blur ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Discount ---
        const handleDiscountFocus = (inputElement) => {
            if (inputElement.value === '0' || inputElement.value === '0.00') {
                inputElement.value = '';
            }
        };

        const handleDiscountBlur = (inputElement) => {
            if (inputElement.value.trim() === '') {
                inputElement.value = '0';
            }
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ updateItem ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
            const index = parseInt(inputElement.getAttribute('data-index'));
            updateItem(index, 'discount', inputElement.value);
        };

        // Init Date
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const strDate = today.toISOString().split('T')[0];
            document.getElementById('billDate').value = strDate;
            document.getElementById('billDateDisplay').value = formatDate(strDate);

            populateCategories();

            for (let i = 0; i < ITEMS_PER_FIRST_PAGE; i++) {
                addItem(false);
            }
            renderTable();

            // Ensure category select is visible by default
            document.getElementById('billCategory').classList.remove('opacity-0', 'pointer-events-none', 'absolute', 'z-0');

            // Check if required libraries are loaded
            if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
                showMessage("üö® ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", true);
            }

            // Initialize signature canvas
            initSignatureCanvas();

            // --- Drag and Drop Logic (omitted for brevity, assume working) ---
            const uploadZone = document.getElementById('uploadZone');
            const defaultClasses = ['border-green-500', 'bg-green-50', 'hover:bg-green-100'];
            const highlightClasses = ['border-blue-700', 'bg-blue-100'];

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            uploadZone.addEventListener('dragenter', highlight, false);
            uploadZone.addEventListener('dragover', highlight, false);
            uploadZone.addEventListener('dragleave', unhighlight, false);
            uploadZone.addEventListener('drop', unhighlight, false);

            function highlight(e) {
                uploadZone.classList.add(...highlightClasses);
                uploadZone.classList.remove(...defaultClasses);
            }

            function unhighlight(e) {
                uploadZone.classList.remove(...highlightClasses);
                uploadZone.classList.add(...defaultClasses);
            }

            uploadZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleImageUpload({ target: { files: files } });
            }
        });

        // Table Logic
        const renderTable = () => {
            const tbody = document.getElementById('itemTableBody');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';

                // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Quantity ‡πÉ‡∏ä‡πâ cleanDecimalInput ‡πÅ‡∏•‡∏∞ inputmode="decimal"**
                tr.innerHTML = `
                    <td class="p-1 sm:p-2 border-r border-gray-300">
                        <input type="text" class="w-full bg-transparent focus:outline-none text-sm sm:text-base" value="${item.name}" oninput="updateItem(${index}, 'name', this.value)" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                    </td>
                    <td class="p-1 sm:p-2 border-r border-gray-300">
                        <input type="number"
                                class="w-full text-right bg-transparent focus:outline-none no-spinners text-sm sm:text-base"
                                value="${item.qty}"
                                oninput="this.value = cleanNumberInput(this.value, 0); updateItem(${index}, 'qty', this.value)"
                                min="0" inputmode="numeric" pattern="[0-9]*">
                    </td>
                    <td class="p-1 sm:p-2 border-r border-gray-300">
                        <input
                            type="text"
                            inputmode="decimal"
                            class="w-full text-right bg-transparent focus:outline-none no-spinners text-sm sm:text-base"
                            value="${item.price}"
                            oninput="
                                this.value = cleanDecimalInput(this.value, 3, 0);
                                updateItem(${index}, 'price', this.value)
                            "
                        >
                    </td>
                    <td class="p-1 sm:p-2 border-r border-gray-300">
                        <input
                            type="text"
                            inputmode="decimal"
                            class="w-full text-right bg-transparent focus:outline-none no-spinners text-red-600 text-sm sm:text-base"
                            value="${item.discount}"
                            oninput="
                                this.value = cleanDecimalInput(this.value, 3, 0);
                                updateItem(${index}, 'discount', this.value)
                            "
                            onfocus="handleDiscountFocus(this)"
                            onblur="handleDiscountBlur(this)"
                            data-index="${index}"
                        >
                    </td>
                    <td class="p-1 sm:p-2 text-right font-semibold text-blue-800 border-r border-gray-300 text-sm sm:text-base">
                        ${formatMoney(item.total)}
                    </td>
                    <td class="p-1 sm:p-2 text-center">
                        <button onclick="deleteItem(${index})" class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100 transition duration-150" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            calculateGrandTotal();
        };

        // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: updateItem ‡∏≠‡πà‡∏≤‡∏ô qty ‡πÄ‡∏õ‡πá‡∏ô parseFloat**
        const updateItem = (index, field, value) => {
            let sanitizedValue = value.trim() === '' ? '' : value;
            items[index][field] = sanitizedValue;

            if (field === 'qty' || field === 'price' || field === 'discount') {

                // Quantity (qty) should be parsed as Float (decimals)
                const q = parseFloat(items[index].qty) || 0;
                // Price (price) and Discount (discount) should be parsed as Float (decimals)
                const p = parseFloat(items[index].price) || 0;
                const d = parseFloat(items[index].discount) || 0;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà: (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô * ‡∏£‡∏≤‡∏Ñ‡∏≤) - ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
                items[index].total = (q * p) - d;

                const tbody = document.getElementById('itemTableBody');
                const row = tbody.rows[index];
                if (row) {
                    row.cells[4].textContent = formatMoney(items[index].total);
                }
            }
            calculateGrandTotal();
        };

        const addItem = (shouldRender = true) => {
            // Price and Discount are set to '0' initially to ensure proper floating point calculation if they are left empty.
            items.push({ name: '', qty: '', price: '', discount: 0, total: 0 });
            if (shouldRender) {
                renderTable();
            }
        };

        const deleteItem = (index) => {
            items.splice(index, 1);
            renderTable();
        };

        const calculateGrandTotal = () => {
            // Use parseFloat for all calculation
            const total = items.reduce((sum, item) => sum + (parseFloat(item.total) || 0), 0);
            document.getElementById('grandTotal').textContent = formatMoney(total);
        };

        // Image Handling (omitted for brevity, assume working)
        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            Array.from(files).forEach(file => {
                if (file.size > 5 * 1024 * 1024) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    receiptImages.push({ id: generateUniqueId(), base64: e.target.result });
                    renderReceipts();
                };
                reader.readAsDataURL(file);
            });
            event.target.value = null;
        }

        // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 593:
        const renderReceipts = () => {
            const container = document.getElementById('receiptsPreviewContainer');
            container.innerHTML = '';
            receiptImages.forEach(img => {
                container.innerHTML += `
            <div class="relative w-40 h-40 bg-white rounded-lg overflow-hidden shadow-2xl transition duration-300 hover:scale-[1.03] ring-2 ring-blue-600 ring-opacity-50 cursor-pointer group">
                <img src="${img.base64}" class="w-full h-full object-cover transition duration-300 group-hover:opacity-80">
                <button 
                    onclick="event.stopPropagation(); deleteReceipt(event, '${img.id}')"  // <--- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    class="absolute top-0 right-0 bg-red-600 hover:bg-red-700 text-white font-bold w-7 h-7 flex items-center justify-center rounded-bl shadow-md transition duration-150 transform hover:scale-105" 
                    title="‡∏•‡∏ö‡∏™‡∏•‡∏¥‡∏õ">&times;
                </button>
            </div>
        `;
            });
        };


        const deleteReceipt = (event, id) => {
            event.preventDefault(); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°
            receiptImages = receiptImages.filter(img => img.id !== id);
            renderReceipts();
        };


        // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: validateInputs ‡∏≠‡πà‡∏≤‡∏ô q ‡πÄ‡∏õ‡πá‡∏ô parseFloat**
        // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: validateInputs ‡∏≠‡πà‡∏≤‡∏ô q ‡πÄ‡∏õ‡πá‡∏ô parseFloat**
        const validateInputs = () => {
            // hideMessage(); // Removed as using Toastify

            const category = getCurrentCategoryValue();
            const purpose = document.getElementById('billPurpose').value.trim();
            const person = document.getElementById('personInCharge').value.trim();

            if (purpose === '') {
                showMessage("üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                document.getElementById('billPurpose').focus();
                return false;
            }
            if (category === '') {
                showMessage("üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏ '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");

                const select = document.getElementById('billCategory');
                const customInput = document.getElementById('customCategoryInput');

                if (select.value === CUSTOM_CATEGORY_KEY) {
                    customInput.focus();
                } else {
                    select.focus();
                }
                return false;
            }
            if (person === '') {
                showMessage("üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                document.getElementById('personInCharge').focus();
                return false;
            }

            // 2. Check Item details
            let errorFound = false;
            let errorIndex = -1;

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ä‡πà‡∏≠‡∏á (‡∏ä‡∏∑‡πà‡∏≠, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î) ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ Total ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô 0
            // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ***
            const itemsToValidate = items.filter(item =>
                item.name.trim() !== '' ||
                (parseFloat(item.qty) || 0) !== 0 ||
                (parseFloat(item.price) || 0) !== 0 ||
                (parseFloat(item.discount) || 0) !== 0
            );

            for (let i = 0; i < itemsToValidate.length; i++) {
                const item = itemsToValidate[i];
                const originalIndex = items.indexOf(item);

                // Quantity (q) and Price (p) must both be a float (allowing decimals)
                const q = parseFloat(item.qty) || 0;
                const p = parseFloat(item.price) || 0;

                // **NEW: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏´‡∏£‡∏∑‡∏≠ Total ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô 0 **
                if (item.name.trim() === '') {
                    showMessage(`üö® ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${originalIndex + 1}: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                    errorFound = true;
                    errorIndex = originalIndex;
                    break;
                }

                // Check Quantity/Price validity as before
                if (q <= 0) {
                    showMessage(`üö® ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${originalIndex + 1}: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' (Quantity) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å`);
                    errorFound = true;
                    errorIndex = originalIndex;
                    break;
                }
                if (p <= 0) { // Check for Price > 0
                    showMessage(`üö® ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${originalIndex + 1}: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢' (Price) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å`);
                    errorFound = true;
                    errorIndex = originalIndex;
                    break;
                }
            }

            if (errorFound) {
                const tbody = document.getElementById('itemTableBody');
                if (errorIndex !== -1 && tbody.rows[errorIndex]) {
                    // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÑ‡∏õ‡∏ó‡∏µ‡πà input '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                    tbody.rows[errorIndex].cells[0].querySelector('input').focus();
                }
                return false;
            }

            return true;
        };
        // --- Template Generation (omitted for brevity, assume working) ---

        const generatePageHtml = (pageItems, pageIndex, totalPages, subTotalBeforeDiscount, totalDiscount, grandTotal, personInCharge) => {
            const isLastPage = (pageIndex === totalPages - 1);

            let startNum;
            if (pageIndex === 0) {
                startNum = 1;
            } else {
                startNum = ITEMS_PER_FIRST_PAGE + ((pageIndex - 1) * ITEMS_PER_SUBSEQUENT_PAGE) + 1;
            }

            let tplBodyContent = '';
            if (pageItems.length === 0 && pageIndex === 0) {
                tplBodyContent = `<tr><td colspan="6" class="text-center py-4 text-gray-500 italic">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</td></tr>`;
            } else {
                pageItems.forEach((item, index) => {
                    const currentNum = startNum + index;
                    tplBodyContent += `
                        <tr>
                            <td class="text-center">${currentNum}</td>
                            <td>${item.name}</td>
                            <td class="text-right">${item.qty || '-'}</td>
                            <td class="text-right">${item.price ? formatMoney(item.price) : '-'}</td>
                            <td class="text-right text-red-600">${item.discount && item.discount > 0 ? formatMoney(item.discount) : '-'}</td>
                            <td class="text-right font-medium">${formatMoney(item.total)}</td>
                        </tr>
                    `;
                });
            }

            let tplFooterContent = '';
            if (isLastPage) {
                tplFooterContent = `
                    <tfoot>
                        <tr class="font-normal bg-gray-50 border-t border-gray-400">
                            <td colspan="5" class="text-right pr-4 pt-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</td>
                            <td class="text-right pt-2">${formatMoney(subTotalBeforeDiscount)}</td>
                        </tr>
                        <tr class="font-normal bg-gray-50">
                            <td colspan="5" class="text-right pr-4 pb-2 text-red-600">‡∏£‡∏ß‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                            <td class="text-right pb-2 text-red-600">(${formatMoney(totalDiscount)})</td>
                        </tr>
                        <tr class="font-bold bg-gray-100 border-t-2 border-blue-600">
                            <td colspan="5" class="text-right pr-4 py-2">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</td>
                            <td class="text-right text-xl py-2">${formatMoney(grandTotal)}</td>
                        </tr>
                    </tfoot>
                `;
            }

            let signatureBlock = '';
            if (isLastPage) {
                const signerName = personInCharge || '.......................................................';
                const signatureImageHtml = signatureData ? `<img src="${signatureData}" style="position: absolute; top: -90px; left: 50%; transform: translateX(-50%); max-width: 200px; max-height: 80px;" alt="‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô">` : '';
                signatureBlock = `
                    <div class="pdf-signature-block" style="position: absolute; bottom: 50px; width: 700px; left: 50px;">
                        <div class="flex justify-between px-10">
                            <div class="text-center" style="width: 250px; position: relative;">
                                <div class="border-b border-gray-400 w-full mb-2"></div>
                                <p class="font-bold">(${signerName})</p>
                                <p class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢</p>
                                ${signatureImageHtml}
                            </div>
                            <div class="text-center" style="width: 250px;">
                                <div class="border-b border-gray-400 w-full mb-2"></div>
                                <p class="font-bold">(...............................................)</p>
                                <p class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏´‡∏£‡∏±‡∏ç‡∏ç‡∏¥‡∏Å/‡∏®‡∏¥‡∏©‡∏¢‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•)</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            const now = new Date();
            const headerInfoHtml = `
                <div class="mb-6 px-4">
                    <table class="w-full text-lg">
                        <tr>
                            <td class="font-bold w-32 py-2 border-0">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</td>
                            <td class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0 w-full">${document.getElementById('billDateDisplay').value}</td>
                        </tr>
                        <tr>
                            <td class="font-bold w-32 py-2 border-0">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</td>
                            <td class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0 w-full">${personInCharge || '-'}</td>
                        </tr>
                        <tr>
                            <td class="font-bold w-32 py-2 border-0">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</td>
                            <td class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0 w-full">${getCurrentCategoryValue() || '-'}</td>
                        </tr>
                        <tr>
                            <td class="font-bold w-32 py-2 border-0">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</td>
                            <td class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0 w-full">${document.getElementById('billPurpose').value || '-'}</td>
                        </tr>
                    </table>
                </div>
            `;

            const titleText = totalPages > 1
                ? `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏ô‡πâ‡∏≤ ${pageIndex + 1} ‡∏à‡∏≤‡∏Å ${totalPages})`
                : `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢`;

            const mainHeaderHtml = `
                <div class="flex items-center justify-between template-header-line">
                    <div class="flex items-center space-x-4">
                        <div class="pdf-logo mr-2">
                        </div>
                        <div class="ml-2">
                            <h1 class="text-3xl font-extrabold text-blue-900 mb-2">‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏à‡∏±‡∏Å‡∏£‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</h1>
                            <p class="text-sm text-gray-500">Children of Light Church</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <h2 class="text-lg font-extrabold text-gray-700">${titleText}</h2>
                        <p class="text-xs text-gray-400 mt-1">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${now.toLocaleString('th-TH')}</p>
                    </div>
                </div>
            `;

            const watermarkHtml = `<div class="pdf-watermark">‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏à‡∏±‡∏Å‡∏£‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</div>`;


            return `
                <div class="pdf-page-content">
                    ${mainHeaderHtml}
                    ${headerInfoHtml}

                    <div class="mb-8">
                        <table class="template-table">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700">
                                    <th class="w-12">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th class="text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Description)</th>
                                    <th class="w-20 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th class="w-28 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                    <th class="w-28 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ö‡∏≤‡∏ó)</th>
                                    <th class="w-32 text-right">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tplBodyContent}
                            </tbody>
                            ${tplFooterContent}
                        </table>
                    </div>

                    ${watermarkHtml}

                    ${signatureBlock}
                </div>
            `;
        };

        // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: generatePDFDocument**
        const generatePDFDocument = async () => {

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();   // ~210 mm
            const pageHeight = doc.internal.pageSize.getHeight(); // ~297 mm

            const validItems = items.filter(item => item.name.trim() !== '' || item.total !== 0);
            const personInCharge = document.getElementById('personInCharge').value;

            let subTotalBeforeDiscount = 0;
            let totalDiscount = 0;

            validItems.forEach(item => {
                const q = parseFloat(item.qty) || 0;
                const p = parseFloat(item.price) || 0;
                const d = parseFloat(item.discount) || 0;

                const itemSubTotal = q * p;
                subTotalBeforeDiscount += itemSubTotal;
                totalDiscount += d;
            });

            const grandTotal = subTotalBeforeDiscount - totalDiscount;

            let totalItemPages;
            if (validItems.length === 0) {
                totalItemPages = 1;
            } else if (validItems.length <= ITEMS_PER_FIRST_PAGE) {
                totalItemPages = 1;
            } else {
                const remainingItems = validItems.length - ITEMS_PER_FIRST_PAGE;
                const subsequentPages = Math.ceil(remainingItems / ITEMS_PER_SUBSEQUENT_PAGE);
                totalItemPages = 1 + subsequentPages;
            }

            const tempContainer = document.getElementById('pdfTemplate');
            tempContainer.innerHTML = '';

            try {
                // --- 1. Generate and Add Item Pages (‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
                for (let i = 0; i < totalItemPages; i++) {
                    if (i > 0) doc.addPage();

                    let start, end, pageItems;

                    if (i === 0) {
                        start = 0;
                        end = ITEMS_PER_FIRST_PAGE;
                    } else {
                        const offset = ITEMS_PER_FIRST_PAGE;
                        start = offset + (i - 1) * ITEMS_PER_SUBSEQUENT_PAGE;
                        end = start + ITEMS_PER_SUBSEQUENT_PAGE;
                    }

                    pageItems = validItems.slice(start, end);

                    const pageHtml = generatePageHtml(pageItems, i, totalItemPages, subTotalBeforeDiscount, totalDiscount, grandTotal, personInCharge);
                    tempContainer.innerHTML = pageHtml;

                    const canvas = await html2canvas(tempContainer.children[0], {
                        scale: 3,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: 800,
                        height: 1123,
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 1);
                    const imgWidth = pageWidth;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                }

                // --- 2. Add Receipts (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: 4 ‡∏£‡∏π‡∏õ‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°) ---
                if (receiptImages.length > 0) {
                    const margin = 10; // ‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© 10mm

                    // ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ
                    const contentWidth = pageWidth - (margin * 2);
                    const contentHeight = pageHeight - (margin * 2);

                    // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á (‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏ö‡∏ô‡∏•‡πà‡∏≤‡∏á)
                    const cellWidth = contentWidth / 2;
                    const cellHeight = contentHeight / 2;

                    for (let i = 0; i < receiptImages.length; i++) {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 1, 5, 9... (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á 4 ‡∏£‡∏π‡∏õ) ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                        if (i % 4 === 0) {
                            doc.addPage();
                        }

                        const img = receiptImages[i];

                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Grid (0, 1, 2, 3) ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                        // indexInPage: 0=‡∏ö‡∏ô‡∏ã‡πâ‡∏≤‡∏¢, 1=‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤, 2=‡∏•‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢, 3=‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤
                        const indexInPage = i % 4;
                        const col = indexInPage % 2;
                        const row = Math.floor(indexInPage / 2);

                        // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô X, Y ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                        const xBase = margin + (col * cellWidth);
                        const yBase = margin + (row * cellHeight);

                        // ‡πÄ‡∏ß‡πâ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏ü‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ (Padding) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
                        const padding = 5;
                        const boxWidth = cellWidth - (padding * 2);
                        const boxHeight = cellHeight - (padding * 2);

                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏ä‡πà‡∏≠‡∏á (Object Fit: Contain)
                        const imgProps = doc.getImageProperties(img.base64);
                        const imgRatio = imgProps.width / imgProps.height;
                        const boxRatio = boxWidth / boxHeight;

                        let finalW, finalH;

                        if (imgRatio > boxRatio) {
                            // ‡∏£‡∏π‡∏õ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á -> ‡∏¢‡∏∂‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á
                            finalW = boxWidth;
                            finalH = finalW / imgRatio;
                        } else {
                            // ‡∏£‡∏π‡∏õ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á -> ‡∏¢‡∏∂‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
                            finalH = boxHeight;
                            finalW = finalH * imgRatio;
                        }

                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á (Center Align)
                        const xOffset = (cellWidth - finalW) / 2;
                        const yOffset = (cellHeight - finalH) / 2;

                        // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏•‡∏á‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏î‡πÜ)
                        doc.addImage(
                            img.base64,
                            'JPEG',
                            xBase + (cellWidth - finalW) / 2, // ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏Å‡∏ô X ‡πÉ‡∏ô Cell
                            yBase + (cellHeight - finalH) / 2, // ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏Å‡∏ô Y ‡πÉ‡∏ô Cell
                            finalW,
                            finalH
                        );
                    }
                }

                return doc;

            } catch (error) {
                console.error("PDF Gen Error", error);
                showMessage("üö® ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF", true);
                return null;
            } finally {
                tempContainer.innerHTML = '';
            }
        };

        // NEW: Utility function to handle button loading state
        const setButtonLoading = (buttonId, isLoading) => {
            // Find button by its onclick attribute value
            const button = document.querySelector(`button[onclick="${buttonId}()"]`);
            if (!button) return;

            if (isLoading) {
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô data-text
                button.setAttribute('data-text', button.textContent.trim());
                button.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...
                `;
                button.disabled = true;
                button.classList.add('opacity-70', 'cursor-not-allowed');
            } else {
                button.textContent = button.getAttribute('data-text') || '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠';
                button.disabled = false;
                button.classList.remove('opacity-70', 'cursor-not-allowed');
                button.removeAttribute('data-text');
            }
        };

        // Actions 
        // **NEW FIX: previewPDF function**
        const previewPDF = async () => {
            if (!validateInputs()) {
                return;
            }
            autoSaveSignature();
            if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
                showMessage("üö® ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", true);
                return;
            }

            setButtonLoading('previewPDF', true); // <<< START LOADING

            // Clean up previous URL if any
            if (currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
                currentBlobUrl = null;
            }

            const doc = await generatePDFDocument();

            setButtonLoading('previewPDF', false); // <<< STOP LOADING

            if (doc) {
                // ‡πÉ‡∏ä‡πâ Blob object ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÅ‡∏ó‡∏ô Data URI String
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                currentBlobUrl = pdfUrl; // ‡πÄ‡∏Å‡πá‡∏ö URL ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î

                document.getElementById('pdfIframe').src = pdfUrl;
                document.getElementById('pdfPreviewModal').classList.remove('hidden');
            }
        };
        // END NEW FIX

        const downloadPDF = async () => {
            if (!validateInputs()) {
                return;
            }

            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ---
            if (receiptImages.length === 0) {
                showMessage("üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF");
                // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏•‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô
                document.getElementById('uploadZone').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            // ---------------------------------------------

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!signatureData) {
                showMessage("üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF");
                return;
            }

            autoSaveSignature();
            if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
                showMessage("üö® ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", true);
                return;
            }

            setButtonLoading('downloadPDF', true); // <<< START LOADING

            const doc = await generatePDFDocument();

            setButtonLoading('downloadPDF', false); // <<< STOP LOADING

            if (doc) {
                const dateISO = document.getElementById('billDate').value;
                const [year, month, day] = dateISO.split('-');
                const dateFilename = `${day}${month}${year}`;

                const personName = document.getElementById('personInCharge').value.trim();
                const sanitizedPersonName = personName
                    .replace(/[^a-zA-Z0-9\u0E00-\u0E7F]+/g, '_')
                    .replace(/_{2,}/g, '_')
                    .replace(/^_|_$/g, '');

                const filename = `CLC_E-Receit_${dateFilename}_${sanitizedPersonName}.pdf`;

                doc.save(filename);
            }
        };

        // Modal Controls
        const closeModal = (e) => { if (e.target.id === 'pdfPreviewModal') hideModal(); };

        // **NEW FIX: hideModal function**
        const hideModal = () => {
            document.getElementById('pdfPreviewModal').classList.add('hidden');
            document.getElementById('pdfIframe').src = '';

            // Clean up Blob URL to release memory
            if (currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
                currentBlobUrl = null;
            }
        };
        // END NEW FIX

        // --- Signature Functions ---
        let isDrawing = false;
        let context;
        let scaleX = 1;
        let scaleY = 1;

        const initSignatureCanvas = () => {
            const canvas = document.getElementById('signatureCanvas');
            const isMobile = window.innerWidth < 640;
            if (isMobile) {
                canvas.width = 300;
                canvas.height = 150;
                canvas.style.width = '100%';
                canvas.style.height = 'auto';
            } else {
                canvas.width = 400;
                canvas.height = 200;
                canvas.style.width = '400px';
                canvas.style.height = '200px';
            }
            scaleX = canvas.width / 400;
            scaleY = canvas.height / 200;
            context = canvas.getContext('2d');
            context.lineWidth = 2;
            context.lineCap = 'round';
            context.strokeStyle = '#000';

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            canvas.addEventListener('touchstart', startDrawingTouch);
            canvas.addEventListener('touchmove', drawTouch);
            canvas.addEventListener('touchend', stopDrawing);
        };

        const startDrawing = (e) => {
            isDrawing = true;
            hasDrawn = true;
            context.beginPath();
            context.moveTo(e.offsetX / scaleX, e.offsetY / scaleY);
        };

        const draw = (e) => {
            if (!isDrawing) return;
            context.lineTo(e.offsetX / scaleX, e.offsetY / scaleY);
            context.stroke();
        };

        const stopDrawing = () => {
            isDrawing = false;
        };

        const startDrawingTouch = (e) => {
            e.preventDefault();
            hasDrawn = true;
            const rect = e.target.getBoundingClientRect();
            const x = (e.touches[0].clientX - rect.left) / scaleX;
            const y = (e.touches[0].clientY - rect.top) / scaleY;
            isDrawing = true;
            context.beginPath();
            context.moveTo(x, y);
        };

        const drawTouch = (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const rect = e.target.getBoundingClientRect();
            const x = (e.touches[0].clientX - rect.left) / scaleX;
            const y = (e.touches[0].clientY - rect.top) / scaleY;
            context.lineTo(x, y);
            context.stroke();
        };

        const clearSignature = () => {
            context.clearRect(0, 0, 400, 200);
            signatureData = null;
            hasDrawn = false;
            updateSaveButton(false);
        };

        const autoSaveSignature = () => {
            if (hasDrawn && !signatureData) {
                const canvas = document.getElementById('signatureCanvas');
                signatureData = canvas.toDataURL('image/png');
                updateSaveButton(true);
            }
        };

        const updateSaveButton = (saved) => {
            const saveButton = document.querySelector('button[onclick="saveSignature()"]');
            if (saved) {
                saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
                saveButton.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded';
                saveButton.disabled = true;
            } else {
                saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô';
                saveButton.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded';
                saveButton.disabled = false;
            }
        };

        const saveSignature = () => {
            autoSaveSignature();
            updateSaveButton(true);
            showMessage("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!", false);
        };

    </script>
</body>

</html>