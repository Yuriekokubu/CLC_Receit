<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สรุปบิลรายจ่าย - คริสตจักรลูกของความสว่าง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    boxShadow: {
                        '3xl': '0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 10px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Global Styles */
        body {
            font-family: 'Sarabun', sans-serif;
        }

        .bill-container {
            font-weight: 400;
        }

        /* Hide spinners in number inputs */
        .no-spinners::-webkit-outer-spin-button,
        .no-spinners::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .no-spinners {
            -moz-appearance: textfield;
        }

        /* Modal Styles */
        #pdfPreviewModal iframe {
            width: 100%;
            height: 80vh;
            border-radius: 0.75rem;
        }

        /* --- PDF TEMPLATE STYLES (สำคัญ) --- */
        #pdfTemplate {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 800px;
            min-height: 1123px;
            background-color: white;
            padding: 40px 50px;
            box-sizing: border-box;
            color: #000;
        }

        /* ตารางใน Template */
        .template-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .template-table th {
            background-color: #f3f4f6;
            /* Gray-100 */
            border: 1px solid #9ca3af;
            /* Gray-400 */
            padding: 8px;
            text-align: center;
            font-weight: bold;
        }

        .template-table td {
            border: 1px solid #9ca3af;
            padding: 8px;
            vertical-align: top;
        }

        .template-header-line {
            border-bottom: 2px solid #1e3a8a;
            /* Blue-900 */
            margin-bottom: 20px;
            padding-bottom: 10px;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans flex flex-col items-center py-8">

    <div class="max-w-7xl mx-auto w-full bg-white p-6 sm:p-8 md:p-12 rounded-2xl shadow-3xl">

        <div id="billContent" class="bill-container p-4 sm:p-6 md:p-8 border-4 border-gray-300 rounded-xl bg-white">

            <header class="text-center mb-6 sm:mb-8 md:mb-10">
                <div class="flex items-center justify-center mb-5 sm:mb-6">
                    <div class="header-logo-from-css w-4 h-5 sm:w-12 sm:h-12 mr-3 object-contain" alt="Church Logo"
                        title="Church Logo">
                    </div>

                    <h1 class="text-xl sm:text-3xl font-extrabold text-blue-900 tracking-wide">
                        คริสตจักรลูกของความสว่าง</h1>
                </div>
                <h2
                    class="text-xl sm:text-2xl font-bold text-gray-700 mb-4 inline-block border-b-2 border-blue-400 pb-2">
                    บิลรายการซื้อของ (Input Form)</h2>

                <div class="flex items-center w-full mt-4 mb-6">
                    <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">วัตถุประสงค์:</span>
                    <input id="billPurpose" type="text" placeholder="เช่น ของใช้สำหรับงานคริสต์มาส..."
                        class="border-b-2 border-gray-400 p-1 text-lg text-gray-800 focus:outline-none focus:border-blue-600 w-full bg-transparent">
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-8">
                    <div class="flex items-center w-full sm:w-1/2">
                        <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">วันเดือนปี:</span>
                        <input id="billDateDisplay" type="text" readonly
                            class="text-lg text-gray-800 focus:outline-none w-full bg-transparent text-center border-b-2 border-gray-400 p-1 font-bold">
                        <input id="billDate" type="hidden" value="">
                    </div>
                    <div class="flex items-center w-full sm:w-1/2">
                        <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">ผู้รับผิดชอบ:</span>
                        <input id="personInCharge" type="text" placeholder="ชื่อผู้รับผิดชอบ"
                            class="border-b-2 border-gray-400 p-1 text-lg text-gray-800 focus:outline-none focus:border-blue-600 w-full text-center bg-transparent">
                    </div>
                </div>
            </header>

            <div class="overflow-x-auto mb-10 shadow-lg rounded-lg border border-gray-300">
                <table class="min-w-full bg-white border-collapse">
                    <thead class="bg-blue-800 text-white">
                        <tr>
                            <th class="py-3 px-4 text-left font-bold w-1/2 border-r border-blue-600">ชื่อสินค้า</th>
                            <th class="py-3 px-4 text-right font-bold w-1/6 border-r border-blue-600">จำนวน</th>
                            <th class="py-3 px-4 text-right font-bold w-1/6 border-r border-blue-600">ราคา/หน่วย</th>
                            <th class="py-3 px-4 text-right font-bold w-1/6 border-r border-blue-600">รวม</th>
                            <th class="py-3 px-4 text-center font-bold w-12">ลบ</th>
                        </tr>
                    </thead>
                    <tbody id="itemTableBody" class="text-gray-700"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" class="py-3 px-4 text-right">
                                <button onclick="addItem()"
                                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow">
                                    + เพิ่มรายการ
                                </button>
                            </td>
                        </tr>
                        <tr class="bg-gray-100 border-t-4 border-blue-600">
                            <td colspan="3" class="py-4 px-4 text-right font-extrabold text-blue-800">รวมทั้งสิ้น</td>
                            <td id="grandTotal" class="py-4 px-4 text-right text-xl font-black text-blue-800">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div id="messageBox" class="mt-6 p-4 rounded-lg hidden font-medium text-center"></div>

        </div>

        <div class="mt-8 pt-6 border-t border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4">แนบสลิป/ใบเสร็จ</h3>

            <div id="uploadZone" onclick="document.getElementById('receiptImageInput').click()"
                class="p-8 border-4 border-dashed border-green-500 rounded-2xl bg-green-50 text-center flex flex-col items-center transition duration-200 hover:bg-green-100 cursor-pointer">

                <svg class="w-12 h-12 text-green-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                <p class="text-lg font-semibold text-gray-700 mb-3">ลากและวางรูปภาพ หรือคลิกที่นี่เพื่อเลือกไฟล์ (สูงสุด
                    5MB/ไฟล์)</p>

                <input type="file" id="receiptImageInput" accept="image/*" multiple onchange="handleImageUpload(event)"
                    class="hidden" />

                <div id="receiptsPreviewContainer" class="mt-4 flex flex-wrap gap-4 justify-center w-full"></div>
            </div>

            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-6 mt-8">
                <button onclick="previewPDF()"
                    class="flex-1 bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 px-8 rounded-xl shadow-xl transition transform hover:scale-[1.02] text-lg">
                    พรีวิว PDF
                </button>
                <button onclick="downloadPDF()"
                    class="flex-1 bg-red-700 hover:bg-red-800 text-white font-bold py-4 px-8 rounded-xl shadow-xl transition transform hover:scale-[1.02] text-lg">
                    ดาวน์โหลด PDF
                </button>
            </div>
        </div>
    </div>

    <div id="pdfTemplate">
        <div class="flex items-center justify-between template-header-line">
            <div class="flex items-center">
                <div class="pdf-logo mr-4">
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold text-blue-900 mb-2">คริสตจักรลูกของความสว่าง</h1>
                    <p class="text-sm text-gray-500">Children of Light Church</p>
                </div>
            </div>
            <div class="text-right">
                <h2 class="text-2xl font-bold text-gray-700">ใบเบิกค่าใช้จ่าย</h2>
                <p id="tpl-export-date" class="text-xs text-gray-400 mt-1"></p>
            </div>
        </div>

        <div class="mb-6 px-4">
            <table class="w-full text-lg">
                <tr>
                    <td class="font-bold w-32 py-2 border-0">วันที่:</td>
                    <td id="tpl-date" class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0"></td>
                </tr>
                <tr>
                    <td class="font-bold w-32 py-2 border-0">ผู้เบิก:</td>
                    <td id="tpl-person" class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0"></td>
                </tr>
                <tr>
                    <td class="font-bold w-32 py-2 border-0">วัตถุประสงค์:</td>
                    <td id="tpl-purpose" class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0"></td>
                </tr>
            </table>
        </div>

        <div class="mb-8">
            <table class="template-table">
                <thead>
                    <tr class="bg-gray-200 text-gray-700">
                        <th class="w-12">ลำดับ</th>
                        <th class="text-left">รายการ (Description)</th>
                        <th class="w-24 text-right">จำนวน</th>
                        <th class="w-32 text-right">ราคา/หน่วย</th>
                        <th class="w-32 text-right">รวม (บาท)</th>
                    </tr>
                </thead>
                <tbody id="tpl-table-body">
                </tbody>
                <tfoot>
                    <tr class="font-bold bg-gray-100">
                        <td colspan="4" class="text-right pr-4">รวมเป็นเงินทั้งสิ้น (Grand Total)</td>
                        <td id="tpl-grand-total" class="text-right text-xl">0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="flex justify-between mt-20 px-10">
            <div class="text-center">
                <div class="border-b border-gray-400 w-64 mb-2"></div>
                <p class="font-bold" id="tpl-signer-name">(.......................................................)</p>
                <p class="text-sm text-gray-500">ผู้ขอเบิกจ่าย</p>
            </div>
            <div class="text-center">
                <div class="border-b border-gray-400 w-64 mb-2"></div>
                <p class="font-bold">(.......................................................)</p>
                <p class="text-sm text-gray-500">ผู้อนุมัติ (เหรัญญิก/ศิษยาภิบาล)</p>
            </div>
        </div>
    </div>

    <div id="pdfPreviewModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4"
        onclick="closeModal(event)">
        <div class="bg-white p-6 rounded-2xl shadow-3xl max-w-7xl w-full h-[95vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-bold text-gray-800">ตัวอย่างเอกสาร PDF</h2>
                <button onclick="hideModal()"
                    class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
            </div>
            <iframe id="pdfIframe"></iframe>
        </div>
    </div>

    <script>
        // --- Logic ---
        let items = [];
        let receiptImages = [];

        // Utilities
        const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);
        const formatDate = (dateValue) => {
            if (!dateValue) return '';
            const dateObj = new Date(dateValue);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${day}/${month}/${year}`;
        };
        const formatMoney = (amount) => parseFloat(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Init Date
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const strDate = today.toISOString().split('T')[0];
            document.getElementById('billDate').value = strDate;
            document.getElementById('billDateDisplay').value = formatDate(strDate);
            addItem(); // Add first row

            // Re-attach listeners for formatting if needed
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') e.preventDefault();
                });
            });
        });

        // Table Logic
        const renderTable = () => {
            const tbody = document.getElementById('itemTableBody');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';

                // มี border-r ครบตามที่แก้ไข
                tr.innerHTML = `
                    <td class="p-2 w-1/2 border-r border-gray-300">
                        <input type="text" class="w-full bg-transparent focus:outline-none" value="${item.name}" oninput="updateItem(${index}, 'name', this.value)" placeholder="ชื่อสินค้า">
                    </td>
                    <td class="p-2 w-1/6 border-r border-gray-300">
                        <input type="number" class="w-full text-right bg-transparent focus:outline-none no-spinners" value="${item.qty}" oninput="updateItem(${index}, 'qty', this.value)" min="0">
                    </td>
                    <td class="p-2 w-1/6 border-r border-gray-300">
                        <input type="number" class="w-full text-right bg-transparent focus:outline-none no-spinners" value="${item.price}" oninput="updateItem(${index}, 'price', this.value)" min="0" step="0.01">
                    </td>
                    <td class="p-2 w-1/6 text-right font-semibold text-blue-800 border-r border-gray-300">
                        ${formatMoney(item.total)}
                    </td>
                    <td class="p-2 text-center">
                        <button onclick="deleteItem(${index})" class="text-red-500 hover:text-red-700">&times;</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            calculateGrandTotal();
        };

        const updateItem = (index, field, value) => {
            items[index][field] = value;

            if (field === 'qty' || field === 'price') {
                const q = parseFloat(items[index].qty) || 0;
                const p = parseFloat(items[index].price) || 0;
                items[index].total = q * p;

                // แก้ไข: อัปเดตตัวเลขในตาราง (DOM) โดยไม่ต้อง Render ใหม่ทั้งหมด (แก้ปัญหา Cursor หาย)
                const tbody = document.getElementById('itemTableBody');
                const row = tbody.rows[index];
                if (row) {
                    // ช่อง "รวม" อยู่คอลัมน์ที่ 4 (index 3)
                    row.cells[3].textContent = formatMoney(items[index].total);
                }
            }
            calculateGrandTotal();
        };

        const addItem = () => {
            items.push({ name: '', qty: '', price: '', total: 0 });
            renderTable();
        };

        const deleteItem = (index) => {
            items.splice(index, 1);
            renderTable();
        };

        const calculateGrandTotal = () => {
            const total = items.reduce((sum, item) => sum + (parseFloat(item.total) || 0), 0);
            document.getElementById('grandTotal').textContent = formatMoney(total);
        };

        // Image Handling
        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            Array.from(files).forEach(file => {
                if (file.size > 5 * 1024 * 1024) return; // Skip > 5MB
                const reader = new FileReader();
                reader.onload = (e) => {
                    receiptImages.push({ id: generateUniqueId(), base64: e.target.result });
                    renderReceipts();
                };
                reader.readAsDataURL(file);
            });
            event.target.value = null;
        }

        const renderReceipts = () => {
            const container = document.getElementById('receiptsPreviewContainer');
            container.innerHTML = '';
            receiptImages.forEach(img => {
                container.innerHTML += `
                    <div class="relative w-24 h-24 bg-gray-200 rounded overflow-hidden shadow">
                        <img src="${img.base64}" class="w-full h-full object-cover">
                        <button onclick="deleteReceipt('${img.id}')" class="absolute top-0 right-0 bg-red-600 text-white w-6 h-6 flex items-center justify-center rounded-bl">&times;</button>
                    </div>
                `;
            });
        };
        const deleteReceipt = (id) => {
            receiptImages = receiptImages.filter(img => img.id !== id);
            renderReceipts();
        };

        // --- Template Populator ---
        const populateTemplateData = () => {
            // 1. Header Info
            document.getElementById('tpl-date').textContent = document.getElementById('billDateDisplay').value;
            const person = document.getElementById('personInCharge').value || '-';
            document.getElementById('tpl-person').textContent = person;
            document.getElementById('tpl-signer-name').textContent = `(${person})`; // ใส่ชื่อในวงเล็บตรงลายเซ็นด้วย
            document.getElementById('tpl-purpose').textContent = document.getElementById('billPurpose').value || '-';

            // Export timestamp
            const now = new Date();
            document.getElementById('tpl-export-date').textContent = `พิมพ์เมื่อ: ${now.toLocaleString('th-TH')}`;

            // 2. Table Rows
            const tplBody = document.getElementById('tpl-table-body');
            tplBody.innerHTML = '';

            // กรองแถวว่างทิ้ง
            const validItems = items.filter(item => item.name.trim() !== '' || item.total > 0);

            if (validItems.length === 0) {
                tplBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500 italic">-- ไม่มีรายการ --</td></tr>`;
            }

            validItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${item.name}</td>
                    <td class="text-right">${item.qty || '-'}</td>
                    <td class="text-right">${item.price ? formatMoney(item.price) : '-'}</td>
                    <td class="text-right font-medium">${formatMoney(item.total)}</td>
                `;
                tplBody.appendChild(tr);
            });

            // 3. Grand Total
            const grandTotal = validItems.reduce((sum, item) => sum + (parseFloat(item.total) || 0), 0);
            document.getElementById('tpl-grand-total').textContent = formatMoney(grandTotal);
        };

        // --- PDF Generation (Updated to use Template) ---
        const generatePDFDocument = async () => {
            // 1. Prepare Data
            populateTemplateData();

            const { jsPDF } = window.jspdf;
            // A4 size in mm
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            // 2. Capture the Template Div (not the Form)
            const templateElement = document.getElementById('pdfTemplate');

            try {
                const canvas = await html2canvas(templateElement, {
                    scale: 2, // Scale up for crisp text
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const imgWidth = pageWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);

                // 3. Add Receipts on new pages
                for (const image of receiptImages) {
                    doc.addPage();
                    const imgProps = doc.getImageProperties(image.base64);
                    const pdfWidth = pageWidth - 20; // 10mm margin
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    // Center image vertically if possible, or start from top
                    let yPos = 10;
                    if (pdfHeight < (pageHeight - 20)) {
                        yPos = (pageHeight - pdfHeight) / 2;
                    }

                    // Check if image is too tall
                    if (pdfHeight > (pageHeight - 20)) {
                        // Fit to height instead
                        const scaledWidth = (imgProps.width * (pageHeight - 20)) / imgProps.height;
                        doc.addImage(image.base64, 'JPEG', (pageWidth - scaledWidth) / 2, 10, scaledWidth, pageHeight - 20);
                    } else {
                        doc.addImage(image.base64, 'JPEG', 10, yPos, pdfWidth, pdfHeight);
                    }
                }

                return doc;

            } catch (error) {
                console.error("PDF Gen Error", error);
                alert("เกิดข้อผิดพลาดในการสร้าง PDF");
                return null;
            }
        };

        // Actions
        const previewPDF = async () => {
            const doc = await generatePDFDocument();
            if (doc) {
                const pdfDataUri = doc.output('datauristring');
                document.getElementById('pdfIframe').src = pdfDataUri;
                document.getElementById('pdfPreviewModal').classList.remove('hidden');
            }
        };

        const downloadPDF = async () => {
            const doc = await generatePDFDocument();
            if (doc) {
                const dateStr = document.getElementById('billDate').value;
                doc.save(`Bill_${dateStr}.pdf`);
            }
        };

        // Modal Controls
        const closeModal = (e) => { if (e.target.id === 'pdfPreviewModal') hideModal(); }
        const hideModal = () => { document.getElementById('pdfPreviewModal').classList.add('hidden'); document.getElementById('pdfIframe').src = ''; }
        const showMessage = (msg) => { /* Optional: simple alert for now */ alert(msg); }

    </script>
</body>

</html>