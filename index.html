<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ - ‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏à‡∏±‡∏Å‡∏£‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    boxShadow: {
                        '3xl': '0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 10px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Global Styles */
        body {
            font-family: 'Sarabun', sans-serif;
        }

        .bill-container {
            font-weight: 400;
        }

        /* Hide spinners in number inputs */
        .no-spinners::-webkit-outer-spin-button,
        .no-spinners::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .no-spinners {
            -moz-appearance: textfield;
        }

        /* Modal Styles */
        #pdfPreviewModal iframe {
            width: 100%;
            height: 80vh;
            border-radius: 0.75rem;
        }

        /* --- PDF TEMPLATE STYLES (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) --- */
        /* div ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏ï‡πà‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ */
        #pdfTemplate {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 800px;
            min-height: 1123px;
            /* A4 height at 96 DPI equivalent to 800px width */
            background-color: white;
            box-sizing: border-box;
            color: #000;
        }

        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ page content ‡πÄ‡∏õ‡πá‡∏ô relative ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏ö‡∏ö absolute */
        .pdf-page-content {
            position: relative;
            /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ */
            width: 800px;
            min-height: 1123px;
            /* A4 height at 96 DPI equivalent to 800px width */
            padding: 40px 50px;
            box-sizing: border-box;
            color: #000;
            background-color: white;
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF Logo */
        .pdf-page-content .pdf-logo {
            width: 70px;
            /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÉ‡∏ô PDF */
            height: 70px;
            border: 3px solid #1e3a8a;
            /* ‡∏Ç‡∏≠‡∏ö‡∏´‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
            border-radius: 50%;
            /* ‡∏ó‡∏£‡∏á‡∏Å‡∏•‡∏° */
            box-sizing: border-box;
            display: inline-block;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Template */
        .template-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .template-table th {
            background-color: #f3f4f6;
            /* Gray-100 */
            border: 1px solid #9ca3af;
            /* Gray-400 */
            padding: 8px;
            text-align: center;
            font-weight: bold;
        }

        .template-table td {
            border: 1px solid #9ca3af;
            padding: 8px;
            vertical-align: top;
        }

        .template-header-line {
            border-bottom: 2px solid #1e3a8a;
            /* Blue-900 */
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Watermark */
        .pdf-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 5em;
            /* 5em is about 80px */
            color: #d1d5db;
            /* Gray-300 */
            opacity: 0.3;
            z-index: -1;
            /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
            pointer-events: none;
            width: 100%;
            text-align: center;
            font-weight: 800;
            /* Extra bold */
            white-space: nowrap;
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Header Logo ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏î‡πà‡∏ô) */
        .header-logo-from-css {
            /* ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á */
            background-color: #ffffff;
            /* Blue-900 */
            border-radius: 50%;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô */
            box-shadow: 0 0 0 4px #bfdbfe, 0 0 0 6px #1e3a8a;
            /* ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Message Box */
        .message-box-error {
            background-color: #fef2f2;
            /* Red-50 */
            color: #ef4444;
            /* Red-500 */
            border: 2px solid #fca5a5;
            /* Red-300 */
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans flex flex-col items-center py-8">

    <div class="max-w-7xl mx-auto w-full bg-white p-6 sm:p-8 md:p-12 rounded-2xl shadow-3xl">
        <div id="messageBox" class="m-6 p-4 rounded-lg hidden font-medium text-center"></div>
        <div id="billContent" class="bill-container p-4 sm:p-6 md:p-8 border-4 border-gray-300 rounded-xl bg-white">

            <header class="text-center mb-6 sm:mb-8 md:mb-10">
                <div class="flex items-center justify-center mb-5 sm:mb-6">
                    <div class="header-logo-from-css w-16 h-16 sm:w-20 sm:h-20 mr-4 object-contain" alt="Church Logo"
                        title="Church Logo">
                    </div>

                    <h1 class="text-xl sm:text-4xl font-extrabold text-blue-900 tracking-wide">
                        ‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏à‡∏±‡∏Å‡∏£‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</h1>
                </div>
                <h2
                    class="text-xl sm:text-2xl font-bold text-gray-700 mb-4 inline-block border-b-2 border-blue-400 pb-2">
                    ‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á</h2>

                <div
                    class="flex flex-col sm:flex-row justify-between items-start w-full mt-4 mb-6 space-y-4 sm:space-y-0 sm:space-x-8">
                    <div class="flex items-center w-full sm:w-1/2">
                        <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</span>
                        <input id="billPurpose" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™..."
                            class="border-b-2 border-gray-400 p-1 text-lg text-gray-800 focus:outline-none focus:border-blue-600 w-full bg-transparent">
                    </div>
                    <div class="flex items-center w-full sm:w-1/2">
                        <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</span>
                        <div class="relative w-full">
                            <select id="billCategory" onchange="handleCategoryChange(this.value)"
                                class="border-b-2 border-gray-400 p-1 text-lg text-gray-800 focus:outline-none focus:border-blue-600 w-full bg-transparent text-center font-bold transition-opacity duration-300">
                            </select>

                            <div id="customCategoryWrapper" class="absolute inset-0 hidden flex items-center">
                                <input id="customCategoryInput" type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏≠‡∏á..."
                                    class="border-b-2 border-blue-600 p-1 text-lg text-gray-800 focus:outline-none w-full bg-transparent text-center font-bold pr-8">
                                <button onclick="revertToCategorySelect()" title="‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
                                    class="absolute right-0 top-1/2 -translate-y-1/2 text-gray-500 hover:text-red-500 p-1 text-xl font-bold leading-none">
                                    &times;
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-8">
                    <div class="flex items-center w-full sm:w-1/2">
                        <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ:</span>
                        <input id="billDateDisplay" type="text" readonly
                            class="text-lg text-gray-800 focus:outline-none w-full bg-transparent text-center border-b-2 border-gray-400 p-1 font-bold">
                        <input id="billDate" type="hidden" value="">
                    </div>
                    <div class="flex items-center w-full sm:w-1/2">
                        <span class="font-semibold text-gray-800 mr-2 whitespace-nowrap">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</span>
                        <input id="personInCharge" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"
                            class="border-b-2 border-gray-400 p-1 text-lg text-gray-800 focus:outline-none focus:border-blue-600 w-full text-center bg-transparent">
                    </div>
                </div>
            </header>

            <div class="overflow-x-auto mb-10 shadow-lg rounded-lg border border-gray-300">
                <table class="min-w-full bg-white border-collapse">
                    <thead class="bg-blue-800 text-white">
                        <tr>
                            <th class="py-3 px-4 text-left font-bold w-4/12 border-r border-blue-600">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="py-3 px-4 text-right font-bold w-1/12 border-r border-blue-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th class="py-3 px-4 text-right font-bold w-2/12 border-r border-blue-600">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th class="py-3 px-4 text-right font-bold w-2/12 border-r border-blue-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ö‡∏≤‡∏ó)</th>
                            <th class="py-3 px-4 text-right font-bold w-2/12 border-r border-blue-600">‡∏£‡∏ß‡∏°
                                (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î)</th>
                            <th class="py-3 px-4 text-center font-bold w-1/12">‡∏•‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody id="itemTableBody" class="text-gray-700"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="py-3 px-4 text-right">
                                <button onclick="addItem()"
                                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow">
                                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                </button>
                            </td>
                        </tr>
                        <tr class="bg-gray-100 border-t-4 border-blue-600">
                            <td colspan="4" class="py-4 px-4 text-right font-extrabold text-blue-800">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
                            </td>
                            <td id="grandTotal" class="py-4 px-4 text-right text-xl font-black text-blue-800">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h3>

            <div id="uploadZone" onclick="document.getElementById('receiptImageInput').click()"
                class="p-8 border-4 border-dashed border-green-500 rounded-2xl bg-green-50 text-center flex flex-col items-center transition duration-200 hover:bg-green-100 cursor-pointer">

                <svg class="w-12 h-12 text-green-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                <p class="text-lg font-semibold text-gray-700 mb-3">‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
                    5MB/‡πÑ‡∏ü‡∏•‡πå)</p>

                <input type="file" id="receiptImageInput" accept="image/*" multiple onchange="handleImageUpload(event)"
                    class="hidden" />

                <div id="receiptsPreviewContainer" class="mt-4 flex flex-wrap gap-4 justify-center w-full"></div>
            </div>

            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-6 mt-8">
                <button onclick="previewPDF()"
                    class="flex-1 bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 px-8 rounded-xl shadow-xl transition transform hover:scale-[1.02] text-lg">
                    ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß PDF
                </button>
                <button onclick="downloadPDF()"
                    class="flex-1 bg-red-700 hover:bg-red-800 text-white font-bold py-4 px-8 rounded-xl shadow-xl transition transform hover:scale-[1.02] text-lg">
                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
                </button>
            </div>
        </div>
    </div>

    <div id="pdfTemplate"></div>


    <div id="pdfPreviewModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4"
        onclick="closeModal(event)">
        <div class="bg-white p-6 rounded-2xl shadow-3xl max-w-7xl w-full h-[95vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-bold text-gray-800">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF</h2>
                <button onclick="hideModal()"
                    class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
            </div>
            <iframe id="pdfIframe"></iframe>
        </div>
    </div>

    <script>
        // --- Logic ---
        let items = [];
        let receiptImages = [];
        const ITEMS_PER_FIRST_PAGE = 10; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
        const ITEMS_PER_SUBSEQUENT_PAGE = 10; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ

        // NEW: Define Category structure (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô)
        const CATEGORIES = {
            '‡∏≠‡∏≤‡∏´‡∏≤‡∏£': ['‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£'],
            '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': ['‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'],
            '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô/‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î': ['‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç', '‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', '‡∏´‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£', '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ']
        };
        const CUSTOM_CATEGORY_KEY = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'; // <--- NEW CONSTANT

        // NEW: Function to populate the category dropdown (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô)
        const populateCategories = () => {
            const select = document.getElementById('billCategory');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>'; // Default/Empty Option

            // Grouped Options
            for (const group in CATEGORIES) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group;
                CATEGORIES[group].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
        };


        // Utilities
        const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);
        const formatDate = (dateValue) => {
            if (!dateValue) return '';
            const dateObj = new Date(dateValue);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${day}/${month}/${year}`;
        };
        const formatMoney = (amount) => parseFloat(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Utility Functions for Message Box
        const showMessage = (msg, isError = true) => {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = msg;
            msgBox.classList.remove('hidden');
            msgBox.classList.remove('message-box-error', 'bg-blue-50', 'text-blue-500', 'border-blue-300');

            if (isError) {
                msgBox.classList.add('message-box-error');
            } else {
                msgBox.classList.add('bg-blue-50', 'text-blue-500', 'border-blue-300');
            }

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(hideMessage, 5000);
        };

        const hideMessage = () => {
            document.getElementById('messageBox').classList.add('hidden');
        };


        // --- START: NEW CATEGORY HANDLER FUNCTIONS ---

        /**
         * ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Select box ‡πÅ‡∏•‡∏∞ Custom input
         */
        const getCurrentCategoryValue = () => {
            const select = document.getElementById('billCategory');
            const customInput = document.getElementById('customCategoryInput');
            const selectedValue = select.value.trim();

            if (selectedValue === CUSTOM_CATEGORY_KEY) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á
                return customInput.value.trim() || '';
            }
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Select box
            return selectedValue;
        };

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Select Box ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
         */
        const handleCategoryChange = (selectedValue) => {
            const select = document.getElementById('billCategory');
            const customWrapper = document.getElementById('customCategoryWrapper');
            const customInput = document.getElementById('customCategoryInput');

            if (selectedValue === CUSTOM_CATEGORY_KEY) {
                // Show custom input, hide select visually
                // ‡πÉ‡∏ä‡πâ opacity-0, pointer-events-none, absolute, z-0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô Select ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ Input ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà
                select.classList.add('opacity-0', 'pointer-events-none', 'absolute', 'z-0');
                customWrapper.classList.remove('hidden');
                customInput.value = ''; // Clear previous input
                customInput.focus();
            } else {
                // Hide custom input, show select
                customWrapper.classList.add('hidden');
                select.classList.remove('opacity-0', 'pointer-events-none', 'absolute', 'z-0');
            }
        };

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á
         */
        const revertToCategorySelect = () => {
            const select = document.getElementById('billCategory');
            const customWrapper = document.getElementById('customCategoryWrapper');
            const customInput = document.getElementById('customCategoryInput');

            // Reset custom value, hide custom input, show select
            customInput.value = '';
            customWrapper.classList.add('hidden');
            select.classList.remove('opacity-0', 'pointer-events-none', 'absolute', 'z-0');
            select.value = ''; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Select box ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            select.focus();
        };

        // --- END: NEW CATEGORY HANDLER FUNCTIONS ---


        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Focus/Blur (‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î) ---
        const handleDiscountFocus = (inputElement) => {
            if (inputElement.value === '0' || inputElement.value === '0.00') {
                inputElement.value = '';
            }
        };

        const handleDiscountBlur = (inputElement) => {
            if (inputElement.value.trim() === '') {
                inputElement.value = '0';
            }
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ updateItem ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
            const index = parseInt(inputElement.getAttribute('data-index'));
            updateItem(index, 'discount', inputElement.value);
        };

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏ß‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
         * @param {string} value ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å input
         * @param {number} minValue ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏≠ 0)
         * @returns {string} ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏õ‡πá‡∏ô string)
         */
        const cleanNumberInput = (value, minValue = 0) => {
            if (value.trim() === '') {
                return '';
            }

            // 1. ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
            let num = Math.round(parseFloat(value) || 0);

            // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î
            if (num < minValue) {
                num = minValue;
            }

            return String(num);
        };


        // Init Date
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const strDate = today.toISOString().split('T')[0];
            document.getElementById('billDate').value = strDate;
            document.getElementById('billDateDisplay').value = formatDate(strDate);

            // NEW: Populate categories on load
            populateCategories();

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° 10 ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å)
            for (let i = 0; i < ITEMS_PER_FIRST_PAGE; i++) {
                addItem(false);
            }
            renderTable();

            // Re-attach listeners for formatting if needed
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') e.preventDefault();
                });
            });

            // --- START: Drag and Drop Logic ---
            const uploadZone = document.getElementById('uploadZone');
            const defaultClasses = ['border-green-500', 'bg-green-50', 'hover:bg-green-100'];
            const highlightClasses = ['border-blue-700', 'bg-blue-100']; // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á

            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // ‡πÄ‡∏ô‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤
            uploadZone.addEventListener('dragenter', highlight, false);
            uploadZone.addEventListener('dragover', highlight, false);

            // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß
            uploadZone.addEventListener('dragleave', unhighlight, false);
            uploadZone.addEventListener('drop', unhighlight, false);

            function highlight(e) {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏ô‡πâ‡∏ô
                uploadZone.classList.add(...highlightClasses);
                // ‡∏•‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏Å‡∏ï‡∏¥
                uploadZone.classList.remove(...defaultClasses);
            }

            function unhighlight(e) {
                // ‡∏•‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏ô‡πâ‡∏ô
                uploadZone.classList.remove(...highlightClasses);
                // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏Å‡∏ï‡∏¥
                uploadZone.classList.add(...defaultClasses);
            }

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå Drop
            uploadZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°
                handleImageUpload({ target: { files: files } });
            }
            // --- END: Drag and Drop Logic ---

        });

        // Table Logic
        const renderTable = () => {
            const tbody = document.getElementById('itemTableBody');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';

                // *** ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö step="0.01" ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ oninput ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° ***
                tr.innerHTML = `
                    <td class="p-2 border-r border-gray-300">
                        <input type="text" class="w-full bg-transparent focus:outline-none" value="${item.name}" oninput="updateItem(${index}, 'name', this.value)" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                    </td>
                    <td class="p-2 border-r border-gray-300">
                        <input type="number" 
                                class="w-full text-right bg-transparent focus:outline-none no-spinners" 
                                value="${item.qty}" 
                                oninput="this.value = cleanNumberInput(this.value, 0); updateItem(${index}, 'qty', this.value)" 
                                min="0" inputmode="numeric" pattern="[0-9]*">
                    </td>
                    <td class="p-2 border-r border-gray-300">
                        <input type="number" 
                                class="w-full text-right bg-transparent focus:outline-none no-spinners" 
                                value="${item.price}" 
                                oninput="this.value = cleanNumberInput(this.value, 0); updateItem(${index}, 'price', this.value)" 
                                min="0" inputmode="numeric" pattern="[0-9]*">
                    </td>
                    <td class="p-2 border-r border-gray-300">
                        <input type="number" 
                            class="w-full text-right bg-transparent focus:outline-none no-spinners text-red-600" 
                            value="${item.discount}" 
                            data-index="${index}"
                            onfocus="handleDiscountFocus(this)" 
                            onblur="handleDiscountBlur(this)" 
                            oninput="this.value = cleanNumberInput(this.value, 0); updateItem(${index}, 'discount', this.value)" 
                            min="0" inputmode="numeric" pattern="[0-9]*">
                    </td>
                    <td class="p-2 text-right font-semibold text-blue-800 border-r border-gray-300">
                        ${formatMoney(item.total)}
                    </td>
                    <td class="p-2 text-center">
                        <button onclick="deleteItem(${index})" class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100 transition duration-150" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                            <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            calculateGrandTotal();
        };

        const updateItem = (index, field, value) => {
            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏°‡∏≠
            // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ cleanNumberInput ‡πÉ‡∏ô oninput ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡πà‡∏≤ value ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏à‡∏∂‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)
            let sanitizedValue = value.trim() === '' ? '' : value; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á 0.00 ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á

            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô items[index] ‡∏î‡πâ‡∏ß‡∏¢ sanitizedValue
            items[index][field] = sanitizedValue;

            // 3. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            if (field === 'qty' || field === 'price' || field === 'discount') {

                // *** ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç *‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°* ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ***
                // ‡πÉ‡∏ä‡πâ parseInt(value, 10) ‡πÅ‡∏ó‡∏ô parseFloat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
                const q = parseInt(items[index].qty, 10) || 0;
                const p = parseInt(items[index].price, 10) || 0;
                const d = parseInt(items[index].discount, 10) || 0;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà: (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô * ‡∏£‡∏≤‡∏Ñ‡∏≤) - ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
                items[index].total = (q * p) - d;

                // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (DOM) ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Render ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 
                const tbody = document.getElementById('itemTableBody');
                const row = tbody.rows[index];
                if (row) {
                    // ‡∏ä‡πà‡∏≠‡∏á "‡∏£‡∏ß‡∏°" ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 5 (index 4)
                    row.cells[4].textContent = formatMoney(items[index].total);
                }
            }
            calculateGrandTotal();
        };

        const addItem = (shouldRender = true) => {
            // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô '' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
            items.push({ name: '', qty: '', price: '', discount: 0, total: 0 });
            if (shouldRender) {
                renderTable();
            }
        };

        const deleteItem = (index) => {
            items.splice(index, 1);
            renderTable();
        };

        const calculateGrandTotal = () => {
            // ‡πÉ‡∏ä‡πâ parseFloat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏£‡∏ß‡∏° (Total) ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° (‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°)
            const total = items.reduce((sum, item) => sum + (parseFloat(item.total) || 0), 0);
            document.getElementById('grandTotal').textContent = formatMoney(total);
        };

        // Image Handling
        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            Array.from(files).forEach(file => {
                if (file.size > 5 * 1024 * 1024) return; // Skip > 5MB
                const reader = new FileReader();
                reader.onload = (e) => {
                    receiptImages.push({ id: generateUniqueId(), base64: e.target.result });
                    renderReceipts();
                };
                reader.readAsDataURL(file);
            });
            event.target.value = null;
        }

        const renderReceipts = () => {
            const container = document.getElementById('receiptsPreviewContainer');
            container.innerHTML = '';
            receiptImages.forEach(img => {
                container.innerHTML += `
                    <div class="relative w-40 h-40 bg-white rounded-lg overflow-hidden shadow-2xl transition duration-300 hover:scale-[1.03] ring-2 ring-blue-600 ring-opacity-50 cursor-pointer group">
                        <img src="${img.base64}" class="w-full h-full object-cover transition duration-300 group-hover:opacity-80">
                        <button onclick="deleteReceipt('${img.id}')" 
                            class="absolute top-0 right-0 bg-red-600 hover:bg-red-700 text-white font-bold w-7 h-7 flex items-center justify-center rounded-bl shadow-md transition duration-150 transform hover:scale-105" 
                            title="‡∏•‡∏ö‡∏™‡∏•‡∏¥‡∏õ">&times;
                        </button>
                    </div>
                `;
            });
        };
        const deleteReceipt = (id) => {
            receiptImages = receiptImages.filter(img => img.id !== id);
            renderReceipts();
        };


        // *** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Validation) - ‡πÉ‡∏ä‡πâ showMessage ‡πÅ‡∏ó‡∏ô alert ***
        const validateInputs = () => {
            hideMessage(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö

            const category = getCurrentCategoryValue(); // <-- ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
            const purpose = document.getElementById('billPurpose').value.trim();
            const person = document.getElementById('personInCharge').value.trim();

            // 1. Check Header fields
            if (purpose === '') {
                showMessage("üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                document.getElementById('billPurpose').focus();
                return false;
            }
            if (category === '') { // <-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
                showMessage("üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏ '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");

                const select = document.getElementById('billCategory');
                const customInput = document.getElementById('customCategoryInput');

                // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏ä‡πà‡∏≠‡∏á
                if (select.value === CUSTOM_CATEGORY_KEY) {
                    customInput.focus();
                } else {
                    select.focus();
                }
                return false;
            }
            if (person === '') {
                showMessage("üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                document.getElementById('personInCharge').focus();
                return false;
            }

            // 2. Check Item details
            let errorFound = false;
            let errorIndex = -1;

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0)
            const itemsToValidate = items.filter(item => item.name.trim() !== '' || item.total !== 0);

            for (let i = 0; i < itemsToValidate.length; i++) {
                const item = itemsToValidate[i];

                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                const originalIndex = items.indexOf(item);

                // ‡πÉ‡∏ä‡πâ parseInt() ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏ß‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                const q = parseInt(item.qty, 10) || 0;
                const p = parseInt(item.price, 10) || 0;

                // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 0 ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0
                if (item.name.trim() !== '' || item.total !== 0) {
                    if (q <= 0) {
                        showMessage(`üö® ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${originalIndex + 1}: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' (Quantity) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏ß‡∏Å`);
                        errorFound = true;
                        errorIndex = originalIndex;
                        break;
                    }
                    if (p <= 0) {
                        showMessage(`üö® ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${originalIndex + 1}: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢' (Price) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏ß‡∏Å`);
                        errorFound = true;
                        errorIndex = originalIndex;
                        break;
                    }
                }
            }

            if (errorFound) {
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á input ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                const tbody = document.getElementById('itemTableBody');
                if (errorIndex !== -1 && tbody.rows[errorIndex]) {
                    // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ô‡∏±‡πâ‡∏ô
                    tbody.rows[errorIndex].cells[0].querySelector('input').focus();
                }
                return false;
            }

            return true;
        };
        // *** ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ***

        // --- Template Generation (Updated for Absolute Signature Block and wider header lines) ---

        const generatePageHtml = (pageItems, pageIndex, totalPages, subTotalBeforeDiscount, totalDiscount, grandTotal, personInCharge) => {
            const isLastPage = (pageIndex === totalPages - 1);

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÜ
            let startNum;
            if (pageIndex === 0) {
                startNum = 1;
            } else {
                // ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å + (‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ * ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)) + 1
                startNum = ITEMS_PER_FIRST_PAGE + ((pageIndex - 1) * ITEMS_PER_SUBSEQUENT_PAGE) + 1;
            }

            // 1. Build Table Body
            let tplBodyContent = '';
            if (pageItems.length === 0 && pageIndex === 0) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢
                tplBodyContent = `<tr><td colspan="6" class="text-center py-4 text-gray-500 italic">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</td></tr>`;
            } else {
                pageItems.forEach((item, index) => {
                    const currentNum = startNum + index;
                    tplBodyContent += `
                        <tr>
                            <td class="text-center">${currentNum}</td>
                            <td>${item.name}</td>
                            <td class="text-right">${item.qty || '-'}</td>
                            <td class="text-right">${item.price ? formatMoney(item.price) : '-'}</td>
                            <td class="text-right text-red-600">${item.discount && item.discount > 0 ? formatMoney(item.discount) : '-'}</td>
                            <td class="text-right font-medium">${formatMoney(item.total)}</td>
                        </tr>
                    `;
                });
            }

            // 2. Grand Total Footer (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ - ‡πÄ‡∏û‡∏¥‡πà‡∏° Subtotal ‡πÅ‡∏•‡∏∞ Total Discount)
            let tplFooterContent = '';
            if (isLastPage) {
                tplFooterContent = `
                    <tfoot>
                        <tr class="font-normal bg-gray-50 border-t border-gray-400">
                            <td colspan="5" class="text-right pr-4 pt-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</td>
                            <td class="text-right pt-2">${formatMoney(subTotalBeforeDiscount)}</td>
                        </tr>
                        <tr class="font-normal bg-gray-50">
                            <td colspan="5" class="text-right pr-4 pb-2 text-red-600">‡∏£‡∏ß‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                            <td class="text-right pb-2 text-red-600">(${formatMoney(totalDiscount)})</td>
                        </tr>
                        <tr class="font-bold bg-gray-100 border-t-2 border-blue-600">
                            <td colspan="5" class="text-right pr-4 py-2">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</td>
                            <td class="text-right text-xl py-2">${formatMoney(grandTotal)}</td>
                        </tr>
                    </tfoot>
                `;
            }

            // 3. Signature Block (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ - ‡πÉ‡∏ä‡πâ fixed width 250px)
            let signatureBlock = '';
            if (isLastPage) {
                const signerName = personInCharge || '.......................................................';
                signatureBlock = `
                    <div class="pdf-signature-block" style="position: absolute; bottom: 50px; width: 700px; left: 50px;">
                        <div class="flex justify-between px-10">
                            <div class="text-center" style="width: 250px;">
                                <div class="border-b border-gray-400 w-full mb-2"></div> 
                                <p class="font-bold">(${signerName})</p>
                                <p class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢</p>
                            </div>
                            <div class="text-center" style="width: 250px;">
                                <div class="border-b border-gray-400 w-full mb-2"></div>
                                <p class="font-bold">(...............................................)</p>
                                <p class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏´‡∏£‡∏±‡∏ç‡∏ç‡∏¥‡∏Å/‡∏®‡∏¥‡∏©‡∏¢‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•)</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 4. Main Header Info (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤ - ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°)
            const now = new Date();
            const headerInfoHtml = `
                <div class="mb-6 px-4">
                    <table class="w-full text-lg">
                        <tr>
                            <td class="font-bold w-32 py-2 border-0">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</td>
                            <td class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0 w-full">${document.getElementById('billDateDisplay').value}</td>
                        </tr>
                        <tr>
                            <td class="font-bold w-32 py-2 border-0">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</td>
                            <td class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0 w-full">${personInCharge || '-'}</td>
                        </tr>
                        <tr>
                            <td class="font-bold w-32 py-2 border-0">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</td>
                            <td class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0 w-full">${getCurrentCategoryValue() || '-'}</td>
                        </tr>
                        <tr>
                            <td class="font-bold w-32 py-2 border-0">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</td>
                            <td class="border-b border-gray-400 py-2 border-t-0 border-l-0 border-r-0 w-full">${document.getElementById('billPurpose').value || '-'}</td>
                        </tr>
                    </table>
                </div>
            `;

            // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Header ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            const titleText = totalPages > 1
                ? `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏ô‡πâ‡∏≤ ${pageIndex + 1} ‡∏à‡∏≤‡∏Å ${totalPages})`
                : `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢`;

            const mainHeaderHtml = `
                <div class="flex items-center justify-between template-header-line">
                    <div class="flex items-center space-x-4">
                        <div class="pdf-logo mr-2">
                        </div>
                        <div class="ml-2">
                            <h1 class="text-3xl font-extrabold text-blue-900 mb-2">‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏à‡∏±‡∏Å‡∏£‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</h1>
                            <p class="text-sm text-gray-500">Children of Light Church</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <h2 class="text-lg font-bold text-gray-700">${titleText}</h2>
                        <p class="text-xs text-gray-400 mt-1">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${now.toLocaleString('th-TH')}</p>
                    </div>
                </div>
            `;

            // NEW: Watermark HTML
            const watermarkHtml = `<div class="pdf-watermark">‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏à‡∏±‡∏Å‡∏£‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</div>`;


            return `
                <div class="pdf-page-content">
                    ${mainHeaderHtml}
                    ${headerInfoHtml}

                    <div class="mb-8">
                        <table class="template-table">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700">
                                    <th class="w-12">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th class="text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Description)</th>
                                    <th class="w-20 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th class="w-28 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                    <th class="w-28 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ö‡∏≤‡∏ó)</th>
                                    <th class="w-32 text-right">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tplBodyContent}
                            </tbody>
                            ${tplFooterContent}
                        </table>
                    </div>

                    ${watermarkHtml}

                    ${signatureBlock}
                </div>
            `;
        };

        // --- PDF Generation (Updated for Multi-Page and Dynamic Content) ---
        const generatePDFDocument = async () => {

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            // Gathers necessary data
            const validItems = items.filter(item => item.name.trim() !== '' || item.total !== 0);
            const personInCharge = document.getElementById('personInCharge').value;

            // *** ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ***
            let subTotalBeforeDiscount = 0;
            let totalDiscount = 0;

            validItems.forEach(item => {
                // ‡πÉ‡∏ä‡πâ parseInt() ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
                const q = parseInt(item.qty, 10) || 0;
                const p = parseInt(item.price, 10) || 0;
                const d = parseInt(item.discount, 10) || 0;

                const itemSubTotal = q * p;
                subTotalBeforeDiscount += itemSubTotal;
                totalDiscount += d;
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Grand Total)
            const grandTotal = subTotalBeforeDiscount - totalDiscount;

            // *** NEW: Calculate total pages for item table with mixed capacities ***
            let totalItemPages;
            if (validItems.length === 0) {
                totalItemPages = 1;
            } else if (validItems.length <= ITEMS_PER_FIRST_PAGE) {
                totalItemPages = 1;
            } else {
                const remainingItems = validItems.length - ITEMS_PER_FIRST_PAGE;
                const subsequentPages = Math.ceil(remainingItems / ITEMS_PER_SUBSEQUENT_PAGE);
                totalItemPages = 1 + subsequentPages;
            }
            // *** END NEW PAGINATION LOGIC ***


            // Use a temporary container to render HTML for canvas capture
            const tempContainer = document.getElementById('pdfTemplate');
            tempContainer.innerHTML = ''; // Clear template content

            try {
                // --- 1. Generate and Add Item Pages ---
                for (let i = 0; i < totalItemPages; i++) {
                    if (i > 0) doc.addPage();

                    let start, end, pageItems;

                    if (i === 0) {
                        // ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å: 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        start = 0;
                        end = ITEMS_PER_FIRST_PAGE;
                    } else {
                        // ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà 11
                        const offset = ITEMS_PER_FIRST_PAGE;
                        start = offset + (i - 1) * ITEMS_PER_SUBSEQUENT_PAGE;
                        end = start + ITEMS_PER_SUBSEQUENT_PAGE;
                    }

                    // Get items for the current page
                    pageItems = validItems.slice(start, end);

                    // Generate HTML for the current page
                    const pageHtml = generatePageHtml(pageItems, i, totalItemPages, subTotalBeforeDiscount, totalDiscount, grandTotal, personInCharge);
                    tempContainer.innerHTML = pageHtml;

                    // Capture the current page content
                    const canvas = await html2canvas(tempContainer.children[0], {
                        scale: 2, // Scale up for crisp text
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: 800, // Fixed width
                        height: 1123, // Fixed height (A4 @ 800px width)
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const imgWidth = pageWidth;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    // Add the image (page) to PDF
                    doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                }

                // --- 2. Add Receipts on New Pages ---
                for (const image of receiptImages) {
                    doc.addPage();
                    const imgProps = doc.getImageProperties(image.base64);
                    const pdfWidth = pageWidth - 20; // 10mm margin
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    // Center image vertically if possible, or start from top
                    let yPos = 10;
                    if (pdfHeight < (pageHeight - 20)) {
                        yPos = (pageHeight - pdfHeight) / 2;
                    }

                    // Check if image is too tall
                    if (pdfHeight > (pageHeight - 20)) {
                        // Fit to height instead
                        const scaledWidth = (imgProps.width * (pageHeight - 20)) / imgProps.height;
                        doc.addImage(image.base64, 'JPEG', (pageWidth - scaledWidth) / 2, 10, scaledWidth, pageHeight - 20);
                    } else {
                        doc.addImage(image.base64, 'JPEG', 10, yPos, pdfWidth, pdfHeight);
                    }
                }

                return doc;

            } catch (error) {
                console.error("PDF Gen Error", error);
                showMessage("üö® ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF", true);
                return null;
            } finally {
                // Clear the temporary container after use
                tempContainer.innerHTML = '';
            }
        };

        // Actions (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å validateInputs)
        const previewPDF = async () => {
            if (!validateInputs()) {
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤ validation ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
            }
            const doc = await generatePDFDocument();
            if (doc) {
                const pdfDataUri = doc.output('datauristring');
                document.getElementById('pdfIframe').src = pdfDataUri;
                document.getElementById('pdfPreviewModal').classList.remove('hidden');
            }
        };

        const downloadPDF = async () => {
            if (!validateInputs()) {
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤ validation ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
            }
            const doc = await generatePDFDocument();
            if (doc) {
                const dateISO = document.getElementById('billDate').value;
                // Convert YYYY-MM-DD to DDMMYYYY
                const [year, month, day] = dateISO.split('-');
                const dateFilename = `${day}${month}${year}`;

                const personName = document.getElementById('personInCharge').value.trim();
                // Sanitize personName: replace non-word characters (including space) with underscore, 
                // allowing Thai characters (\u0E00-\u0E7F)
                const sanitizedPersonName = personName
                    .replace(/[^a-zA-Z0-9\u0E00-\u0E7F]+/g, '_')
                    .replace(/_{2,}/g, '_') // Replace multiple underscores with single one
                    .replace(/^_|_$/g, ''); // Remove leading/trailing underscores

                // New filename format: CLC_E-Receit_ddmmyyyy_{‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å}.pdf
                const filename = `CLC_E-Receit_${dateFilename}_${sanitizedPersonName}.pdf`;

                doc.save(filename);
            }
        };

        // Modal Controls
        const closeModal = (e) => { if (e.target.id === 'pdfPreviewModal') hideModal(); };
        const hideModal = () => { document.getElementById('pdfPreviewModal').classList.add('hidden'); document.getElementById('pdfIframe').src = ''; };

    </script>
</body>

</html>